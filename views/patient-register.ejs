<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register Patient - RehabPlus System</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">

    <!-- Design System -->
    <link href="/public/css/variables.css" rel="stylesheet">
    <link href="/public/css/base.css" rel="stylesheet">
    <link href="/public/css/accessibility.css" rel="stylesheet">

    <style>
        /* --- DASHBOARD THEME VARIABLES --- */
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --surface-color: #ffffff;
            --background-color: #f3f4f6;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            
            /* Legacy overrides for Register Page */
            --theme-primary: #6366f1;
            --theme-secondary: #8b5cf6;
            --input-bg: #f8fafc;
        }

        body {
            background-color: #f0f2f5; /* Matches dashboard.ejs exactly */
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- MAIN LAYOUT --- */
        main {
            padding-top: 1.5rem;
            padding-bottom: 3rem;
        }

        /* --- PAGE HEADER (Dashboard Style) --- */
        .page-header {
            background: var(--surface-color);
            border-radius: var(--border-radius-md);
            padding: 0.8rem 1.2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(255,255,255,0.5);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .page-header h1 {
            font-weight: 800;
            font-size: 1.4rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0;
        }

        .page-header .subtitle {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* --- CARDS & FORMS --- */
        .form-card {
            background: var(--surface-color);
            border-radius: var(--border-radius-md);
            border: 1px solid rgba(229, 231, 235, 0.8);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .form-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Decorative top border for cards */
        .form-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary-gradient);
            opacity: 0.8;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .icon-box {
            width: 42px;
            height: 42px;
            background: #f0f2ff; /* Light indigo tint */
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: var(--theme-primary);
            font-size: 1.25rem;
        }

        .section-title h5 {
            margin: 0;
            font-weight: 700;
            color: var(--text-main);
            font-size: 1.1rem;
        }

        .section-title span {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Form Controls */
        .form-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.35rem;
        }

        .form-control, .form-select {
            background-color: var(--input-bg);
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.6rem 0.8rem;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            color: var(--text-main);
        }

        .form-control:focus, .form-select:focus {
            background-color: #fff;
            border-color: var(--theme-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-control::placeholder {
            color: #9ca3af;
        }

        /* Required Badge */
        .required::after {
            content: "*";
            color: #ef4444;
            margin-left: 2px;
            font-weight: bold;
        }

        /* Buttons */
        .btn {
            border: none;
            font-weight: 600;
            border-radius: 6px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            color: white;
        }

        .btn-light {
            background: #fff;
            color: var(--text-main);
            border: 1px solid #e5e7eb !important;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        /* Checkboxes */
        .form-check-input {
            width: 1.1em;
            height: 1.1em;
            margin-top: 0.2em;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }
        
        .form-check-input:checked {
            background-color: var(--theme-primary);
            border-color: var(--theme-primary);
        }

        /* Utilities */
        .hidden-until-verified {
            display: none !important;
        }
        
        .text-micro {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            display: block;
        }

        /* Animations */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-card {
            animation: slideUp 0.4s ease-out forwards;
        }

        /* Smart Card Button Animation */
        .btn-smart-card {
            border: 1px solid var(--theme-primary);
            color: var(--theme-primary);
            background: rgba(99, 102, 241, 0.05);
        }
        .btn-smart-card:hover {
            background: var(--theme-primary);
            color: white;
        }
    </style>
</head>
<body>
    <%- include('partials/header') %>
    
    <!-- Mobile navbar toggle -->
    <nav class="navbar navbar-dark bg-dark d-md-none">
        <div class="container-fluid">
            <span class="navbar-brand font-weight-bold">RehabPlus</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <%- include('partials/sidebar', { user, activePage: 'patient-register' }) %>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                
                <!-- Page Header (Dashboard Style) -->
                <div class="page-header flex-column flex-md-row">
                    <div>
                        <h1 class="h2">Register New Patient</h1>
                        <span class="subtitle">Enter patient details for HL7 FHIR record creation</span>
                    </div>
                    <div class="mt-3 mt-md-0">
                        <button type="button" class="btn btn-light btn-sm" onclick="history.back()">
                            <i class="bi bi-arrow-left me-2"></i>Back to List
                        </button>
                    </div>
                </div>

                <form id="patientForm" novalidate>

                    <!-- CARD 1: Identity Verification -->
                    <div class="form-card">
                        <div class="section-header">
                            <div class="icon-box">
                                <i class="bi bi-fingerprint"></i>
                            </div>
                            <div class="section-title">
                                <h5>Identity Verification</h5>
                                <span>Step 1: Verify uniqueness</span>
                            </div>
                        </div>

                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <label for="pidInput" class="form-label mb-0">Thai National ID</label>
                                    <button type="button" class="btn btn-sm btn-smart-card py-0 px-2" id="btnReadCard">
                                        <i class="bi bi-credit-card-2-front me-1"></i> Read from Card
                                    </button>
                                </div>
                                <input type="text" class="form-control form-control-lg" id="pidInput" name="pidInput" maxlength="13" placeholder="xxxxxxxxxxxxx">
                                <span class="text-micro">Enter 13-digit ID number</span>
                                <div class="invalid-feedback" id="pidErrorText"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="passportInput" class="form-label">Passport Number</label>
                                <input type="text" class="form-control form-control-lg" id="passportInput" name="passportInput" maxlength="20" placeholder="Passport No.">
                                <span class="text-micro">For international patients</span>
                                <div class="invalid-feedback" id="passportErrorText"></div>
                            </div>
                            
                            <div class="col-12 mt-2">
                                <button class="btn btn-primary w-100 py-2 shadow-sm" type="button" id="btnCheckID">
                                    <i class="bi bi-search me-2"></i> Check Database & Generate HN
                                </button>
                            </div>

                            <!-- Verification Alert Zone -->
                            <div class="col-12" id="verificationSection" style="display: none;">
                                <div class="alert py-3 px-3 shadow-sm" role="alert" id="verificationAlert"></div>
                            </div>

                            <!-- Auto Generated Info -->
                            <div class="col-md-6">
                                <label for="hn" class="form-label required">Hospital Number (HN)</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border"><i class="bi bi-hash text-muted"></i></span>
                                    <input type="text" class="form-control" id="hn" name="hn" required readonly placeholder="Waiting for verification..." style="background-color: #f8fafc;">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="pt_number" class="form-label">PT Number</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border"><i class="bi bi-clipboard-data text-muted"></i></span>
                                    <input type="text" class="form-control" id="pt_number" name="pt_number" readonly placeholder="Auto-generated on save" style="background-color: #f8fafc;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden fields -->
                        <input type="hidden" id="pid" name="pid">
                        <input type="hidden" id="passport" name="passport">
                        <div class="mt-3">
                             <label for="ssn" class="form-label text-muted" style="font-size: 0.7rem;">Other ID (Optional)</label>
                             <input type="text" class="form-control form-control-sm w-50" id="ssn" name="ssn" placeholder="SSN">
                        </div>
                    </div>

                    <!-- MAIN FORM CONTENT -->
                    
                    <!-- Name & Demographics Row -->
                    <div class="row">
                        <!-- Left Column: Personal Info -->
                        <div class="col-lg-6 mb-4 hidden-until-verified" id="nameSection">
                            <div class="form-card h-100">
                                <div class="section-header">
                                    <div class="icon-box">
                                        <i class="bi bi-person-vcard"></i>
                                    </div>
                                    <div class="section-title">
                                        <h5>Personal Information</h5>
                                        <span>Basic demographics</span>
                                    </div>
                                </div>

                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label for="title" class="form-label">Title</label>
                                        <input type="text" class="form-control" id="title" list="titleList" placeholder="Select or type...">
                                        <datalist id="titleList">
                                            <option value="นาย">นาย (Mr.)</option>
                                            <option value="นาง">นาง (Mrs.)</option>
                                            <option value="นางสาว">นางสาว (Miss)</option>
                                            <option value="Mr.">Mr.</option>
                                            <option value="Mrs.">Mrs.</option>
                                            <option value="Ms.">Ms.</option>
                                            <option value="Miss">Miss</option>
                                            <option value="Dr.">Dr.</option>
                                            <option value="Prof.">Prof.</option>
                                        </datalist>
                                    </div>
                                    <div class="col-md-9">
                                        <label for="first_name" class="form-label required">First Name</label>
                                        <input type="text" class="form-control" id="first_name" required placeholder="Enter first name">
                                    </div>
                                    <div class="col-md-12">
                                        <label for="last_name" class="form-label required">Last Name</label>
                                        <input type="text" class="form-control" id="last_name" required placeholder="Enter last name">
                                    </div>
                                    <div class="col-md-12">
                                        <label for="middle_name" class="form-label">Middle Name</label>
                                        <input type="text" class="form-control" id="middle_name" placeholder="Optional">
                                    </div>
                                    
                                    <% if (user.role === 'ADMIN' || user.role === 'PT' || user.role === 'PT_ADMIN') { %>
                                    <div class="col-12 mt-4 pt-3 border-top">
                                        <label for="clinic_id" class="form-label required text-primary"><i class="bi bi-building me-1"></i> Assigned Clinic</label>
                                        <select class="form-select" id="clinic_id" required>
                                            <option value="">Select Clinic location...</option>
                                        </select>
                                    </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Demographics & Contact -->
                        <div class="col-lg-6 mb-4 hidden-until-verified" id="demographicsSection">
                            <div class="form-card h-100">
                                <div class="section-header">
                                    <div class="icon-box">
                                        <i class="bi bi-calendar3"></i>
                                    </div>
                                    <div class="section-title">
                                        <h5>Demographics & Contact</h5>
                                        <span>Vital statistics & Address</span>
                                    </div>
                                </div>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="dob" class="form-label required">Date of Birth</label>
                                        <input type="text" class="form-control flatpickr" id="dob" required placeholder="DD/MM/YYYY">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="gender" class="form-label required">Gender</label>
                                        <select class="form-select" id="gender" required>
                                            <option value="">Select...</option>
                                            <option value="M">Male</option>
                                            <option value="F">Female</option>
                                            <option value="O">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="marital_status" class="form-label">Marital Status</label>
                                        <select class="form-select" id="marital_status">
                                            <option value="">Select...</option>
                                            <option value="S">Single</option>
                                            <option value="M">Married</option>
                                            <option value="D">Divorced</option>
                                            <option value="W">Widowed</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="language_primary" class="form-label">Language</label>
                                        <input type="text" class="form-control" id="language_primary" placeholder="Thai/English" list="languageList">
                                        <datalist id="languageList">
                                            <option value="th">Thai</option>
                                            <option value="en">English</option>
                                        </datalist>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="phone" class="form-label">Phone</label>
                                        <input type="tel" class="form-control" id="phone" placeholder="08x-xxx-xxxx">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="mobile" class="form-label">Mobile</label>
                                        <input type="tel" class="form-control" id="mobile" placeholder="08x-xxx-xxxx">
                                    </div>
                                    <div class="col-md-12">
                                        <label for="email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="email" placeholder="name@example.com">
                                    </div>
                                    <div class="col-md-12">
                                        <label for="address_main" class="form-label">Address</label>
                                        <textarea class="form-control" id="address_main" rows="2" placeholder="Enter address from Thai ID card or manually"></textarea>
                                        <span class="text-micro">Address from Thai ID card reader or manual entry</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Address Details -->
                    <div class="row hidden-until-verified">
                        <div class="col-12">
                            <div class="form-card mb-4">
                                <div class="section-header">
                                    <div class="icon-box">
                                        <i class="bi bi-geo-alt"></i>
                                    </div>
                                    <div class="section-title">
                                        <h5>Address Details</h5>
                                        <span>Residence information</span>
                                    </div>
                                </div>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="address_line1" class="form-label">Address Line 1</label>
                                        <input type="text" class="form-control" id="address_line1" placeholder="No, Street, Soi">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="address_line2" class="form-label">Address Line 2</label>
                                        <input type="text" class="form-control" id="address_line2" placeholder="Unit, Building, Floor">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="address_city" class="form-label">City/Tambon</label>
                                        <input type="text" class="form-control" id="address_city" placeholder="City">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="address_district" class="form-label">District/Amphoe</label>
                                        <input type="text" class="form-control" id="address_district" placeholder="District">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="address_state" class="form-label">Province/State</label>
                                        <input type="text" class="form-control" id="address_state" placeholder="Province">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="address_postal_code" class="form-label">Postal Code</label>
                                        <input type="text" class="form-control" id="address_postal_code" placeholder="Postal Code">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="address_country" class="form-label">Country</label>
                                        <select class="form-select" id="address_country">
                                            <option value="TH">Thailand</option>
                                            <option value="US">United States</option>
                                            <option value="GB">United Kingdom</option>
                                            <option value="CN">China</option>
                                            <option value="JP">Japan</option>
                                            <option value="DE">Germany</option>
                                            <option value="FR">France</option>
                                        </select>
                                    </div>
                                    <!-- Hidden full address string compiled by JS -->
                                    <input type="hidden" id="address">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Emergency & Clinical -->
                    <div class="row hidden-until-verified" id="emergencyClinicalSection">
                        <div class="col-lg-6 mb-4">
                            <!-- Emergency Card -->
                            <div class="form-card h-100">
                                <div class="section-header">
                                    <div class="icon-box">
                                        <i class="bi bi-person-exclamation"></i>
                                    </div>
                                    <div class="section-title">
                                        <h5>Emergency Contact</h5>
                                        <span>In case of emergency</span>
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="emergency_contact" class="form-label">Contact Name</label>
                                        <input type="text" class="form-control" id="emergency_contact" placeholder="Full name">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="emergency_relationship" class="form-label">Relationship</label>
                                        <input type="text" class="form-control" id="emergency_relationship" placeholder="Spouse/Parent" list="relationshipList">
                                        <datalist id="relationshipList">
                                            <option value="Spouse"><option value="Parent"><option value="Child"><option value="Sibling"><option value="Friend">
                                        </datalist>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="emergency_phone" class="form-label">Emergency Phone</label>
                                        <input type="tel" class="form-control" id="emergency_phone" placeholder="Phone number">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="emergency_email" class="form-label">Emergency Email</label>
                                        <input type="email" class="form-control" id="emergency_email" placeholder="Email address">
                                    </div>
                                    <div class="col-12">
                                        <label for="emergency_address" class="form-label">Emergency Address</label>
                                        <input type="text" class="form-control" id="emergency_address" placeholder="Full address">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6 mb-4">
                            <!-- Clinical Card -->
                             <div class="form-card h-100">
                                <div class="section-header">
                                    <div class="icon-box">
                                        <i class="bi bi-heart-pulse"></i>
                                    </div>
                                    <div class="section-title">
                                        <h5>Clinical Assessment</h5>
                                        <span>Initial diagnosis</span>
                                    </div>
                                </div>

                                <div class="row g-4">
                                    <div class="col-md-12">
                                        <label for="diagnosis" class="form-label required">Primary Diagnosis / Chief Complaint</label>
                                        <textarea class="form-control" id="diagnosis" rows="3" required placeholder="Describe the patient's main condition..."></textarea>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="medical_history" class="form-label">Medical History</label>
                                        <textarea class="form-control" id="medical_history" rows="2" placeholder="Relevant past conditions"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="medications" class="form-label">Current Medications</label>
                                        <textarea class="form-control" id="medications" rows="2" placeholder="List current medications"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="allergies" class="form-label">Allergies</label>
                                        <textarea class="form-control" id="allergies" rows="2" placeholder="Known allergies"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="doctor_note" class="form-label">Doctor's Notes</label>
                                        <textarea class="form-control" id="doctor_note" rows="2" placeholder="Internal notes"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rehab Goals -->
                    <div class="row hidden-until-verified" id="rehabSection">
                        <div class="col-12 mb-4">
                            <div class="form-card">
                                <div class="section-header">
                                    <div class="icon-box">
                                        <i class="bi bi-clipboard2-pulse"></i>
                                    </div>
                                    <div class="section-title">
                                        <h5>Rehabilitation Plan</h5>
                                        <span>Goals and Plan</span>
                                    </div>
                                </div>
                                
                                <div class="row g-3">
                                    <!-- Rehab Goals Area -->
                                    <div class="col-12">
                                        <div class="p-3 bg-light rounded-3 border border-dashed">
                                            <label class="form-label mb-3">Rehabilitation Goals</label>
                                            <div class="d-flex flex-wrap gap-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="Pain reduction" id="goal1">
                                                    <label class="form-check-label" for="goal1">Pain reduction</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="Improve ROM" id="goal2">
                                                    <label class="form-check-label" for="goal2">Improve ROM</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="Strengthen muscles" id="goal3">
                                                    <label class="form-check-label" for="goal3">Muscle Strength</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="Improve function" id="goal4">
                                                    <label class="form-check-label" for="goal4">Functionality</label>
                                                </div>
                                            </div>
                                            <input type="text" class="form-control mt-3" id="rehab_goal_other" placeholder="Other specific goals...">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label for="body_area" class="form-label">Target Body Area</label>
                                        <select class="form-select" id="body_area">
                                            <option value="">Select Area...</option>
                                            <option value="Neck">Neck</option>
                                            <option value="Shoulder">Shoulder</option>
                                            <option value="Elbow">Elbow</option>
                                            <option value="Wrist/Hand">Wrist/Hand</option>
                                            <option value="Upper Back">Upper Back</option>
                                            <option value="Lower Back">Lower Back</option>
                                            <option value="Hip">Hip</option>
                                            <option value="Knee">Knee</option>
                                            <option value="Ankle/Foot">Ankle/Foot</option>
                                            <option value="Multiple Areas">Multiple</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="frequency" class="form-label">Frequency</label>
                                        <select class="form-select" id="frequency">
                                            <option value="">Select Frequency...</option>
                                            <option value="Daily">Daily</option>
                                            <option value="3 times/week">3x / week</option>
                                            <option value="2 times/week">2x / week</option>
                                            <option value="Weekly">Weekly</option>
                                            <option value="As needed">As needed</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="expected_duration" class="form-label">Duration</label>
                                        <select class="form-select" id="expected_duration">
                                            <option value="">Select Duration...</option>
                                            <option value="1-2 weeks">1-2 weeks</option>
                                            <option value="2-4 weeks">2-4 weeks</option>
                                            <option value="1-2 months">1-2 months</option>
                                            <option value="2-3 months">2-3 months</option>
                                            <option value="3-6 months">3-6 months</option>
                                            <option value="Long-term">Long-term</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="precaution" class="form-label">Precautions</label>
                                        <textarea class="form-control" id="precaution" rows="2" placeholder="Any precautions..."></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="contraindication" class="form-label">Contraindications</label>
                                        <textarea class="form-control" id="contraindication" rows="2" placeholder="Any contraindications..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Actions -->
                    <div class="d-flex justify-content-end gap-3 mt-4 mb-5 hidden-until-verified" id="submitButtons">
                        <button type="button" class="btn btn-secondary px-4" onclick="clearForm()">
                            <i class="bi bi-x-circle me-2"></i> Clear
                        </button>
                        <button type="submit" class="btn btn-primary px-5">
                            <i class="bi bi-check-lg me-2"></i> Register Patient
                        </button>
                    </div>

                </form>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- Template for ID Available -->
    <template id="templateIdAvailable">
        <div class="alert alert-success border-0 shadow-sm" role="alert">
            <div class="d-flex align-items-center">
                <div class="bg-success text-white rounded-circle p-2 me-3"><i class="bi bi-check-lg"></i></div>
                <div>
                    <h6 class="alert-heading mb-1 fw-bold">ID Verified Successfully</h6>
                    <p class="mb-0 small">This ID is unique. You can proceed with registration.</p>
                    <div class="mt-2">
                         <span class="badge bg-white text-success border border-success">New HN: <span id="previewPTHN">PT25xxx</span></span>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Template for ID Exists -->
    <template id="templateIdExists">
        <div class="alert alert-warning border-0 shadow-sm" role="alert">
            <div class="d-flex align-items-start">
                <div class="bg-warning text-white rounded-circle p-2 me-3"><i class="bi bi-exclamation-triangle-fill"></i></div>
                <div class="flex-grow-1">
                    <h6 class="alert-heading mb-1 fw-bold">Duplicate ID Detected</h6>
                    <p class="mb-2 small">This ID is already registered in the system.</p>

                    <div class="card bg-white border-0 shadow-sm mb-3">
                        <div class="card-body p-3">
                            <div class="row g-2 small">
                                <div class="col-md-6"><strong>HN:</strong> <span id="existingHN">-</span></div>
                                <div class="col-md-6"><strong>PT#:</strong> <span id="existingPT">-</span></div>
                                <div class="col-md-6"><strong>Name:</strong> <span id="existingName">-</span></div>
                                <div class="col-md-6"><strong>Clinic:</strong> <span id="existingClinic">-</span></div>
                                <div class="col-md-6"><strong>DOB:</strong> <span id="existingDOB">-</span></div>
                                <div class="col-md-6"><strong>Reg:</strong> <span id="existingDate">-</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btnViewPatient">
                            <i class="bi bi-eye"></i> View Patient
                        </button>
                        <button type="button" class="btn btn-sm btn-warning text-white" id="btnCreatePN">
                            <i class="bi bi-plus-circle"></i> Create New PN Case
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Template for Error -->
    <template id="templateVerificationError">
        <div class="alert alert-danger border-0 shadow-sm" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-x-circle-fill me-2 fs-4"></i>
                <div>
                    <h6 class="alert-heading mb-1 fw-bold">Verification Failed</h6>
                    <p class="mb-0 small" id="errorMessage">Unable to verify ID. Please try again.</p>
                </div>
            </div>
        </div>
    </template>

    <!-- ORIGINAL JAVASCRIPT RESTORED AND MATCHED -->
    <script>
        // ============================================================================
        // HL7 FHIR Patient Registration - Logic
        // ============================================================================

        // Utility function: Get cookie value
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Format date from DD/MM/YYYY to YYYY-MM-DD for backend
        function convertDateToISO(dateStr) {
            if (!dateStr) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                return `${year}-${month}-${day}`;
            }
            return dateStr;
        }

        // Validate DD/MM/YYYY date format
        function validateDateFormat(dateStr) {
            if (!dateStr) return false;
            const regex = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
            const match = dateStr.match(regex);
            if (!match) return false;

            const day = parseInt(match[1], 10);
            const month = parseInt(match[2], 10);
            const year = parseInt(match[3], 10);

            if (month < 1 || month > 12) return false;
            if (day < 1 || day > 31) return false;
            if (year < 1900 || year > new Date().getFullYear()) return false;
            const daysInMonth = new Date(year, month, 0).getDate();
            if (day > daysInMonth) return false;

            return true;
        }

        // Initialize Flatpickr
        const dobPicker = flatpickr("#dob", {
            dateFormat: "d/m/Y",
            allowInput: true
        });

        // Load clinics
        async function loadClinics() {
            try {
                const response = await fetch('/api/clinics', {
                    headers: {}
                });

                if (response.ok) {
                    const clinics = await response.json();
                    const select = document.getElementById('clinic_id');
                    if (select) {
                        clinics.forEach(clinic => {
                            const option = document.createElement('option');
                            option.value = clinic.id;
                            option.textContent = clinic.name;
                            select.appendChild(option);
                        });

                        // Pre-select user's clinic if CLINIC role
                        const user = JSON.parse(localStorage.getItem('user') || '{}');
                        if (user.role === 'CLINIC' && user.clinic_id) {
                            select.value = user.clinic_id;
                            select.disabled = true;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading clinics:', error);
            }
        }

        // Validate Thai National ID (13 digits with checksum)
        function validateThaiNationalID(id) {
            if (!/^\d{13}$/.test(id)) return false;
            let sum = 0;
            for (let i = 0; i < 12; i++) {
                sum += parseInt(id[i]) * (13 - i);
            }
            const checksum = (11 - (sum % 11)) % 10;
            return checksum === parseInt(id[12]);
        }

        // Validate email
        function validateEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        // Auto-fill address text from structured fields
        function updateAddressText() {
            const line1 = document.getElementById('address_line1')?.value || '';
            const line2 = document.getElementById('address_line2')?.value || '';
            const city = document.getElementById('address_city')?.value || '';
            const district = document.getElementById('address_district')?.value || '';
            const state = document.getElementById('address_state')?.value || '';
            const postal = document.getElementById('address_postal_code')?.value || '';
            const countryEl = document.getElementById('address_country');
            const country = countryEl ? countryEl.options[countryEl.selectedIndex].text : '';

            const parts = [line1, line2, city, district, state, postal, country].filter(p => p.trim() !== '');
            const fullAddress = parts.join(', ');

            if (fullAddress) {
                document.getElementById('address').value = fullAddress;
            }
        }

        // Setup auto-fill listeners
        const addressFields = ['address_line1', 'address_line2', 'address_city', 'address_district', 'address_state', 'address_postal_code', 'address_country'];
        addressFields.forEach(fieldId => {
            document.getElementById(fieldId)?.addEventListener('input', updateAddressText);
        });

        // Validate National ID on blur
        document.getElementById('pidInput')?.addEventListener('blur', (e) => {
            const value = e.target.value;
            if (value && value.length === 13) {
                if (!validateThaiNationalID(value)) {
                    e.target.classList.add('is-invalid');
                    document.getElementById('pidErrorText').textContent = 'Invalid Thai ID Checksum';
                } else {
                    e.target.classList.remove('is-invalid');
                    e.target.classList.add('is-valid');
                }
            }
        });

        // Validate email on blur
        document.getElementById('email')?.addEventListener('blur', (e) => {
            const value = e.target.value;
            if (value && !validateEmail(value)) {
                e.target.classList.add('is-invalid');
            } else {
                e.target.classList.remove('is-invalid');
                if (value) e.target.classList.add('is-valid');
            }
        });

        // Form submission
        document.getElementById('patientForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate form
            const form = e.target;
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                showAlert('Please fill in all required fields correctly', 'danger');
                // Scroll to first invalid
                const firstInvalid = form.querySelector(':invalid');
                if(firstInvalid) firstInvalid.scrollIntoView({behavior: 'smooth', block: 'center'});
                return;
            }

            // Collect rehabilitation goals
            const goals = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                goals.push(cb.value);
            });
            const otherGoals = document.getElementById('rehab_goal_other').value;
            if (otherGoals) {
                goals.push(...otherGoals.split(',').map(g => g.trim()));
            }

            // Validate and convert date
            const dobValue = document.getElementById('dob').value.trim();
            if (dobValue && !validateDateFormat(dobValue)) {
                showAlert('Please enter a valid date in DD/MM/YYYY format', 'danger');
                document.getElementById('dob').focus();
                return;
            }

            // Build HL7 FHIR-compliant payload
            const formData = {
                // Identifiers
                hn: document.getElementById('hn').value,
                pt_number: document.getElementById('pt_number').value || undefined,
                pid: document.getElementById('pid').value, // Hidden field populated by validation js
                passport_no: document.getElementById('passport').value, // Hidden field populated by validation js
                ssn: document.getElementById('ssn').value,

                // Name
                title: document.getElementById('title').value,
                first_name: document.getElementById('first_name').value,
                middle_name: document.getElementById('middle_name').value,
                last_name: document.getElementById('last_name').value,

                // Demographics
                gender: document.getElementById('gender').value,
                dob: convertDateToISO(dobValue),
                marital_status: document.getElementById('marital_status').value,
                language_primary: document.getElementById('language_primary').value,

                // Contact
                phone: document.getElementById('phone').value,
                mobile: document.getElementById('mobile').value,
                email: document.getElementById('email').value,

                // Address (use address_main field value for the database address field)
                address: document.getElementById('address_main').value || document.getElementById('address').value,
                address_line1: document.getElementById('address_line1').value,
                address_line2: document.getElementById('address_line2').value,
                address_city: document.getElementById('address_city').value,
                address_district: document.getElementById('address_district').value,
                address_state: document.getElementById('address_state').value,
                address_postal_code: document.getElementById('address_postal_code').value,
                address_country: document.getElementById('address_country').value,

                // Emergency Contact
                emergency_contact: document.getElementById('emergency_contact').value,
                emergency_relationship: document.getElementById('emergency_relationship').value,
                emergency_phone: document.getElementById('emergency_phone').value,
                emergency_email: document.getElementById('emergency_email').value,
                emergency_address: document.getElementById('emergency_address').value,

                // Clinical
                diagnosis: document.getElementById('diagnosis').value,
                medical_history: document.getElementById('medical_history').value,
                allergies: document.getElementById('allergies').value,
                medications: document.getElementById('medications').value,

                // Rehabilitation
                rehab_goal: goals.join(', '),
                rehab_goal_other: document.getElementById('rehab_goal_other').value,
                body_area: document.getElementById('body_area').value,
                frequency: document.getElementById('frequency').value,
                expected_duration: document.getElementById('expected_duration').value,
                precaution: document.getElementById('precaution').value,
                contraindication: document.getElementById('contraindication').value,
                doctor_note: document.getElementById('doctor_note').value
            };

            // Add clinic_id if available
            const clinicSelect = document.getElementById('clinic_id');
            if (clinicSelect) {
                formData.clinic_id = clinicSelect.value;
            }

            try {
            const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Registering...';

                // Log form data for debugging
                console.log('Submitting patient registration:', {
                    hn: formData.hn,
                    name: `${formData.first_name} ${formData.last_name}`,
                    dob: formData.dob,
                    clinic_id: formData.clinic_id,
                    totalFields: Object.keys(formData).length
                });

                const response = await fetch('/api/patients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert(`Patient registered successfully! PT Number: ${result.pt_number}`, 'success');

                    // Ask if want to create PN case
                    setTimeout(() => {
                        if (confirm('Do you want to create a PN case for this patient?')) {
                            window.location.href = `/patient/${result.patient_id}#create-pn`;
                        } else {
                            window.location.href = '/patients';
                        }
                    }, 1000);
                } else if (response.status === 400) {
                    // Handle validation errors
                    const error = await response.json();
                    let errorMessage = 'Validation Error:<br>';

                    if (error.errors && Array.isArray(error.errors)) {
                        // Express-validator errors
                        error.errors.forEach(err => {
                            errorMessage += `• ${err.param}: ${err.msg}<br>`;
                        });
                    } else if (error.error) {
                        errorMessage = error.error;
                    }

                    console.error('Validation failed:', error);
                    showAlert(errorMessage, 'warning');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;

                    // Try to focus on the first invalid field
                    if (error.errors && error.errors.length > 0) {
                        const firstError = error.errors[0];
                        const field = document.getElementById(firstError.param);
                        if (field) {
                            field.focus();
                            field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                } else {
                    const error = await response.json();

                    // Build detailed error message
                    let errorMessage = error.error || 'Registration failed';

                    // Add error details if available
                    if (error.details) {
                        errorMessage += '<br><small class="text-muted">' + error.details + '</small>';
                    }

                    // Add error code if available
                    if (error.code) {
                        errorMessage += '<br><small class="text-muted">Error Code: ' + error.code + '</small>';
                    }

                    // Log full error to console for debugging
                    console.error('Patient registration failed:', {
                        status: response.status,
                        error: error,
                        formData: formData
                    });

                    showAlert(errorMessage, 'danger');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Network error:', error);
                showAlert('Network error. Please try again.', 'danger');
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-lg me-2"></i> Register Patient';
            }
        });

        function clearForm() {
            if (confirm('Are you sure you want to clear all form data? This cannot be undone.')) {
                document.getElementById('patientForm').reset();
                document.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
                    el.classList.remove('is-valid', 'is-invalid');
                });
                // Hide main content again until verified
                // Manually hide sections by ID
                document.getElementById('nameSection').classList.add('hidden-until-verified');
                document.getElementById('demographicsSection').classList.add('hidden-until-verified');
                document.getElementById('emergencyClinicalSection').classList.add('hidden-until-verified');
                document.getElementById('rehabSection').classList.add('hidden-until-verified');
                document.getElementById('submitButtons').classList.add('hidden-until-verified');
                
                document.getElementById('verificationSection').style.display = 'none';
                document.getElementById('hn').value = '';
                showAlert('Form cleared', 'info');
            }
        }

        function showAlert(message, type = 'info') {
            const existingAlerts = document.querySelectorAll('.alert-floating');
            existingAlerts.forEach(alert => alert.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-floating shadow`;
            alertDiv.role = 'alert';
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '1050';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss=\"alert\"></button>
            `;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // --- SMART CARD READER LOGIC ---
        const btnReadCard = document.getElementById('btnReadCard');
        if (btnReadCard) {
            btnReadCard.addEventListener('click', function() {
                const btn = this;
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Reading...';
                btn.disabled = true;

                fetch('/api/thai_card')
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'waiting' || !data.cid) {
                            alert('No new card data found. Please ensure the card is inserted.');
                        } else {
                            // Populate PID
                            const pidInput = document.getElementById('pidInput');
                            if(pidInput) {
                                pidInput.value = data.cid;
                                // Trigger validation styles
                                pidInput.dispatchEvent(new Event('blur'));
                            }

                            // Populate Title - Thai ID cards provide title data
                            // Try multiple possible field names for title
                            const titleValue = data.th_title || data.title_th || data.prefix || data.titlenameTH || data.th_prefix || data.title;
                            console.log('Thai Card Reader - All data received:', data);
                            console.log('Thai Card Reader - Title field value:', titleValue);

                            if(titleValue) {
                                const titleInput = document.getElementById('title');
                                // Map Thai titles from ID card to our standard options
                                const titleMap = {
                                    'นาย': 'นาย',
                                    'นาง': 'นาง',
                                    'นางสาว': 'นางสาว',
                                    'น.ส.': 'นางสาว',
                                    'Mr.': 'Mr.',
                                    'Mrs.': 'Mrs.',
                                    'Ms.': 'Ms.',
                                    'Miss': 'Miss'
                                };
                                const mappedTitle = titleMap[titleValue] || titleValue;
                                titleInput.value = mappedTitle;
                                console.log('Thai Card Title populated:', titleValue, '-> mapped to:', mappedTitle);
                            } else {
                                console.log('Thai Card: No title field found. Available fields:', Object.keys(data));
                            }

                            // Populate Name
                            if(data.th_fname) document.getElementById('first_name').value = data.th_fname;
                            if(data.th_lname) document.getElementById('last_name').value = data.th_lname;

                            // Gender
                            const genderSelect = document.getElementById('gender');
                            if(data.gender === 'Male') genderSelect.value = 'M';
                            else if(data.gender === 'Female') genderSelect.value = 'F';

                            // DOB (YYYYMMDD -> DD/MM/YYYY) - Convert Buddhist year to Christian year
                            if(data.dob && data.dob.length === 8) {
                                let y = parseInt(data.dob.substr(0,4));
                                const m = data.dob.substr(4,2);
                                const d = data.dob.substr(6,2);

                                // Convert Buddhist year (BE) to Christian year (AD)
                                // Thai ID cards typically use Buddhist Era (BE = AD + 543)
                                if(y > 2400) {
                                    y = y - 543; // Convert BE to AD
                                }

                                const formatted = `${d}/${m}/${y}`;
                                document.getElementById('dob').value = formatted;
                                // Update flatpickr instance
                                if(dobPicker) dobPicker.setDate(formatted);
                            }

                            // Address - populate both the new address_main field and structured fields
                            if(data.address) {
                                // Populate the main address field (new field replacing fax)
                                const addressMain = document.getElementById('address_main');
                                if(addressMain) {
                                    addressMain.value = data.address;
                                }

                                // Also populate address_line1 for structured address
                                const addr1 = document.getElementById('address_line1');
                                if(addr1) {
                                    addr1.value = data.address;
                                    addr1.dispatchEvent(new Event('input'));
                                }
                            }

                            // Auto-Check ID to show form
                            // We wait a moment for the user to see the ID filled
                            setTimeout(() => {
                                document.getElementById('btnCheckID').click();
                            }, 500);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Error connecting to card service.');
                    })
                    .finally(() => {
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                    });
            });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            loadClinics();
            console.log('HL7 FHIR Patient Registration - Ready');
        });
    </script>

    <!-- Load HN Validation JavaScript -->
    <script src="/public/js/hn-validation.js?v=1765446492000"></script>

</body>
</html>
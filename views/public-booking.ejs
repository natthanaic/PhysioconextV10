<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment - RehabPlus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <!-- Design System & Accessibility (Mocked for single file) -->
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --ai-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); /* AI Theme */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 30px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .back-button {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            display: inline-block;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            transform: translateY(-2px);
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .progress-step::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 50%;
            width: 100%;
            height: 3px;
            background: #e2e8f0;
            z-index: 0;
        }

        .progress-step:first-child::before {
            left: 50%;
        }

        .progress-step:last-child::before {
            width: 0;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #a0aec0;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .progress-step.active .step-circle {
            background: var(--primary-gradient);
            border-color: #667eea;
            color: white;
        }

        .progress-step.completed .step-circle {
            background: #48bb78;
            border-color: #48bb78;
            color: white;
        }

        .step-label {
            margin-top: 10px;
            font-weight: 600;
            color: #a0aec0;
        }

        .progress-step.active .step-label,
        .progress-step.completed .step-label {
            color: #2d3748;
        }

        /* Booking Form */
        .booking-container {
            max-width: 1000px;
            margin: -30px auto 50px;
            position: relative;
            z-index: 1;
        }

        .booking-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Calendar & Time Slots */
        .calendar-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .flatpickr-calendar {
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important;
            border: none !important;
            border-radius: 12px !important;
        }
        
        .flatpickr-day.selected {
            background: var(--primary-gradient) !important;
            border-color: #667eea !important;
        }

        /* Booking Indicators on Calendar */
        .flatpickr-day.has-bookings {
            position: relative;
        }

        .booking-indicator {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            z-index: 1;
        }

        .booking-indicator.low {
            background: #48c774; /* Green - Low bookings */
        }

        .booking-indicator.medium {
            background: #ffc107; /* Yellow - Medium bookings */
        }

        .booking-indicator.high {
            background: #f5576c; /* Red - High bookings */
        }

        .time-slot {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .time-slot:hover:not(.disabled) {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .time-slot.selected {
            background: var(--primary-gradient);
            color: white;
            border-color: #667eea;
        }

        .time-slot.disabled {
            background: #f7fafc;
            color: #a0aec0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Pain Assessment */
        .pain-zone-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            height: 100%;
            position: relative;
        }

        .pain-zone-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .pain-zone-card.selected {
            background: var(--primary-gradient);
            color: white;
            border-color: #667eea;
        }

        .pain-zone-card.ai-recommended {
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
            animation: pulse-ai 2s infinite;
        }

        @keyframes pulse-ai {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        .pain-zone-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* Package Cards */
        .package-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .package-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .package-card.selected {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-color: #667eea;
            border-width: 3px;
        }

        .package-icon {
            width: 60px;
            height: 60px;
            background: var(--primary-gradient);
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            margin-bottom: 15px;
        }

        /* Form Elements */
        .form-label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        /* Buttons */
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #718096;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        /* AI Feature Styles */
        .btn-ai {
            background: var(--ai-gradient);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 50px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            transition: all 0.3s;
            margin-bottom: 25px;
        }
        .btn-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
            color: white;
        }

        .btn-ai-sm {
            background: transparent;
            border: 1px solid #6366f1;
            color: #6366f1;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-ai-sm:hover {
            background: var(--ai-gradient);
            color: white;
            border-color: transparent;
        }

        /* Hide/Show Steps */
        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Calendar Booking Indicators */
        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.85rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .booking-card { padding: 25px; }
            .header h1 { font-size: 1.8rem; }
            .progress-steps { flex-direction: column; gap: 20px; }
            .progress-step::before { display: none; }
        }
        
        /* Modal Styles override */
        .ai-modal-header {
            background: var(--ai-gradient);
            color: white;
            border-radius: calc(0.5rem - 1px) calc(0.5rem - 1px) 0 0;
        }
    </style>
</head>
<body>
    <!-- Skip to main content for keyboard users -->
    <a href="#booking-form-section" class="d-none">Skip to booking form</a>

    <!-- Header -->
    <header class="header" role="banner">
        <div class="container">
            <nav class="d-flex justify-content-between align-items-center flex-wrap" aria-label="Main navigation">
                <div class="mb-2 mb-md-0">
                    <a href="#" class="back-button" aria-label="Go back to home page" onclick="location.reload()">
                        <i class="bi bi-arrow-left" aria-hidden="true"></i> Back to Home
                    </a>
                </div>
                <div>
                    <a href="#" class="back-button" aria-label="Staff login">
                        <i class="bi bi-person-circle" aria-hidden="true"></i> Staff Login
                    </a>
                </div>
            </nav>
            <div class="text-center mt-4">
                <h1><i class="bi bi-calendar-check" aria-hidden="true"></i> Book Your Appointment</h1>
                <p class="mb-0">LANTAVAFIX Clinic - Quick and Easy Booking</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="booking-form-section" class="booking-container" role="main" aria-label="Appointment booking form">
        <div class="container">
            <!-- Booking Card -->
            <div class="booking-card">
                <!-- Progress Steps -->
                <div class="progress-steps">
                    <div class="progress-step active" data-step="1">
                        <div class="step-circle"><i class="bi bi-calendar3"></i></div>
                        <div class="step-label">Select Date & Time</div>
                    </div>
                    <div class="progress-step" data-step="2">
                        <div class="step-circle"><i class="bi bi-hospital"></i></div>
                        <div class="step-label">Service Selection</div>
                    </div>
                    <div class="progress-step" data-step="3">
                        <div class="step-circle"><i class="bi bi-person"></i></div>
                        <div class="step-label">Your Information</div>
                    </div>
                </div>

                <!-- Step 1: Select Date & Time -->
                <div id="step-1" class="step-content active">
                    <h4 class="section-title">Select Your Appointment Date & Time</h4>

                    <!-- AI Feature: Complete Smart Booking -->
                    <div class="text-center mb-3">
                        <button type="button" class="btn btn-ai btn-lg" onclick="openSmartBookingModal()">
                            <i class="bi bi-stars"></i> Let AI Book My Entire Appointment
                        </button>
                        <div class="text-muted small mt-2">AI will analyze your symptoms and find the perfect date, time & treatment</div>
                    </div>

                    <div class="calendar-container mb-4">
                        <input type="text" id="date-picker" class="form-control text-center d-none" placeholder="Click to select date">
                        <!-- Legend is auto-generated by JS in flatpickr or static below -->
                        <div class="calendar-legend">
                            <div class="legend-item"><span class="legend-dot" style="background-color: #48bb78;"></span> Low</div>
                            <div class="legend-item"><span class="legend-dot" style="background-color: #f6ad55;"></span> Medium</div>
                            <div class="legend-item"><span class="legend-dot" style="background-color: #fc8181;"></span> High</div>
                        </div>
                    </div>

                    <div id="time-slots-container" style="display: none;">
                        <h5 class="text-center mb-3">Available Time Slots</h5>
                        <div id="time-slots-grid" class="row justify-content-center">
                            <!-- Time slots will be loaded here -->
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-primary btn-lg" id="btn-next-step1" disabled>
                            Continue to Service Selection <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Pain Assessment & Service Selection -->
                <div id="step-2" class="step-content">
                    <h4 class="section-title">What brings you here today?</h4>

                    <!-- AI Feature: Symptom Analysis -->
                    <div class="text-center">
                        <button type="button" class="btn btn-ai" onclick="openAIModal()">
                            <i class="bi bi-stars"></i> Not sure? Analyze with AI
                        </button>
                    </div>

                    <!-- Pain Zone Selection -->
                    <div class="mb-4">
                        <h5 class="mb-3 text-center">Select the area of concern:</h5>
                        <div class="row g-3 justify-content-center">
                            <!-- Neck -->
                            <div class="col-md-3 col-6">
                                <div class="pain-zone-card" data-zone="neck">
                                    <div class="pain-zone-icon" aria-hidden="true">ü¶¥</div>
                                    <h6>Neck</h6>
                                </div>
                            </div>
                            <!-- Shoulder -->
                            <div class="col-md-3 col-6">
                                <div class="pain-zone-card" data-zone="shoulder">
                                    <div class="pain-zone-icon" aria-hidden="true">üí™</div>
                                    <h6>Shoulder</h6>
                                </div>
                            </div>
                            <!-- Back -->
                            <div class="col-md-3 col-6">
                                <div class="pain-zone-card" data-zone="back">
                                    <div class="pain-zone-icon" aria-hidden="true">üîÑ</div>
                                    <h6>Back</h6>
                                </div>
                            </div>
                            <!-- Knee -->
                            <div class="col-md-3 col-6">
                                <div class="pain-zone-card" data-zone="knee">
                                    <div class="pain-zone-icon" aria-hidden="true">ü¶µ</div>
                                    <h6>Knee</h6>
                                </div>
                            </div>
                            <!-- Hip -->
                            <div class="col-md-3 col-6">
                                <div class="pain-zone-card" data-zone="hip">
                                    <div class="pain-zone-icon" aria-hidden="true">ü¶ø</div>
                                    <h6>Hip</h6>
                                </div>
                            </div>
                            <!-- Ankle -->
                            <div class="col-md-3 col-6">
                                <div class="pain-zone-card" data-zone="ankle">
                                    <div class="pain-zone-icon" aria-hidden="true">ü¶∂</div>
                                    <h6>Ankle/Foot</h6>
                                </div>
                            </div>
                            <!-- Elbow -->
                            <div class="col-md-3 col-6">
                                <div class="pain-zone-card" data-zone="elbow">
                                    <div class="pain-zone-icon" aria-hidden="true">üí™</div>
                                    <h6>Elbow</h6>
                                </div>
                            </div>
                             <!-- Other -->
                             <div class="col-md-3 col-6">
                                <div class="pain-zone-card" data-zone="other">
                                    <div class="pain-zone-icon" aria-hidden="true">‚ûï</div>
                                    <h6>Other</h6>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommended Packages -->
                    <div id="packages-container" style="display: none;">
                        <h5 class="mb-3 text-center">Recommended Services:</h5>
                        <div id="packages-list" class="row justify-content-center">
                            <!-- Packages will be loaded dynamically by public-booking.js -->
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-secondary me-2" id="btn-back-step2">
                            <i class="bi bi-arrow-left"></i> Back
                        </button>
                        <button type="button" class="btn btn-primary" id="btn-next-step2" disabled>
                            Continue to Information <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Your Information -->
                <div id="step-3" class="step-content">
                    <h4 class="section-title">Your Contact Information</h4>

                    <form id="booking-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="walk-in-name" class="form-label">Full Name <span class="text-danger">*</span></label>
                                <input type="text" id="walk-in-name" class="form-control" placeholder="Enter your full name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="walk-in-email" class="form-label">Email Address <span class="text-danger">*</span></label>
                                <input type="email" id="walk-in-email" class="form-control" placeholder="Enter your email address" required>
                            </div>
                            <div class="col-12 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <label for="reason" class="form-label mb-0">Additional Notes (Optional)</label>
                                    <button type="button" class="btn-ai-sm" onclick="polishNotes()">
                                        <i class="bi bi-stars"></i> Polish with AI
                                    </button>
                                </div>
                                <textarea id="reason" class="form-control" rows="3" placeholder="Any additional information..."></textarea>
                                <small id="ai-polish-status" class="text-muted"></small>
                            </div>
                        </div>

                        <!-- AI Booking Summary (shown only if booked via AI) -->
                        <div id="ai-booking-summary" class="alert alert-success d-none mt-4">
                            <h6><i class="bi bi-stars"></i> AI-Assisted Booking</h6>
                            <div id="ai-booking-details"></div>
                        </div>

                        <!-- Booking Summary -->
                        <div class="alert alert-info mt-4">
                            <h6><i class="bi bi-info-circle"></i> Booking Summary:</h6>
                            <ul class="mb-0">
                                <li><strong>Clinic:</strong> LANTAVAFIX</li>
                                <li><strong>Date:</strong> <span id="summary-date">-</span></li>
                                <li><strong>Time:</strong> <span id="summary-time">-</span></li>
                                <li><strong>Service:</strong> <span id="summary-service">-</span></li>
                            </ul>
                        </div>

                        <div class="text-center mt-4">
                            <button type="button" class="btn btn-secondary me-2" id="btn-back-step3">
                                <i class="bi bi-arrow-left"></i> Back
                            </button>
                            <button type="submit" id="submit-btn" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle"></i> Confirm Booking
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Success -->
                <div id="success-screen" class="step-content text-center py-5">
                    <div class="mb-4 text-success" style="font-size: 5rem;">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <h2>Booking Confirmed!</h2>
                    <p>We have received your appointment request.</p>
                    <button class="btn btn-primary mt-3" onclick="location.reload()">Book Another</button>
                </div>
            </div>

            <!-- My Bookings Section (From original) -->
            <div id="my-bookings-card" class="mt-4" style="display: none;">
                <div class="booking-card">
                    <h4 class="section-title">
                        <i class="bi bi-list-check"></i> Your Recent Bookings
                    </h4>
                    <div id="my-bookings-list">
                        <!-- Bookings will be loaded here -->
                        <p class="text-center text-muted">No recent bookings found locally.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center py-4 mt-5" style="background: #2d3748; color: white;">
        <div class="container">
            <p class="mb-0">
                <small>&copy; 2025 RehabPlus. All rights reserved.</small>
            </p>
        </div>
    </footer>

    <!-- AI Modal -->
    <div class="modal fade" id="aiModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header ai-modal-header text-white">
                    <h5 class="modal-title"><i class="bi bi-stars"></i> AI Symptom Checker</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted mb-3">Describe your symptoms and AI will recommend the best treatment for you.</p>

                    <div class="mb-3">
                        <label for="ai-symptom-input" class="form-label fw-bold">What are your symptoms?</label>
                        <textarea class="form-control" id="ai-symptom-input" rows="3" placeholder="E.g., Sharp pain in lower back when bending"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="ai-duration-input" class="form-label fw-bold">How long have you had these symptoms?</label>
                        <select class="form-select" id="ai-duration-input">
                            <option value="">Select duration...</option>
                            <option value="less than 3 days">Less than 3 days</option>
                            <option value="3 days to 1 week">3 days to 1 week</option>
                            <option value="1 to 3 weeks">1 to 3 weeks</option>
                            <option value="1 to 3 months">1 to 3 months</option>
                            <option value="more than 3 months">More than 3 months (Chronic)</option>
                            <option value="not sure">Not sure</option>
                        </select>
                    </div>

                    <div id="ai-result" class="alert alert-light border d-none"></div>
                    <button type="button" class="btn w-100 text-white" style="background: var(--ai-gradient); border-radius: 50px;" id="btn-analyze" onclick="analyzeSymptoms()">
                        <i class="bi bi-stars"></i> Analyze & Recommend
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Booking Modal -->
    <div class="modal fade" id="smartBookingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header ai-modal-header text-white">
                    <h5 class="modal-title"><i class="bi bi-stars"></i> Complete AI Booking Assistant</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted mb-4">
                        <i class="bi bi-magic"></i> <strong>Let AI handle your entire booking!</strong><br>
                        Tell me about your symptoms and when you'd like to come, and I'll automatically find the best date, time, and treatment for you.
                    </p>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="smart-symptom-input" class="form-label fw-bold">
                                <i class="bi bi-heart-pulse"></i> What are your symptoms?
                            </label>
                            <textarea class="form-control" id="smart-symptom-input" rows="3" placeholder="E.g., Sharp pain in lower back when bending" required></textarea>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="smart-duration-input" class="form-label fw-bold">
                                <i class="bi bi-clock-history"></i> How long have you had these symptoms?
                            </label>
                            <select class="form-select mb-2" id="smart-duration-input">
                                <option value="">Select duration...</option>
                                <option value="less than 3 days">Less than 3 days</option>
                                <option value="3 days to 1 week">3 days to 1 week</option>
                                <option value="1 to 3 weeks">1 to 3 weeks</option>
                                <option value="1 to 3 months">1 to 3 months</option>
                                <option value="more than 3 months">More than 3 months (Chronic)</option>
                                <option value="not sure">Not sure</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="smart-date-preference-input" class="form-label fw-bold">
                            <i class="bi bi-calendar-event"></i> When would you prefer to come?
                        </label>
                        <textarea class="form-control" id="smart-date-preference-input" rows="2" placeholder="E.g., 'Next week', 'This month', 'After I get back from Koh Lanta', 'As soon as possible'"></textarea>
                        <small class="text-muted">üí° Optional: Mention your preferred timeframe, specific days, or any schedule constraints.</small>
                    </div>

                    <div id="smart-booking-result" class="alert alert-light border d-none"></div>
                    <button type="button" class="btn w-100 text-white btn-lg" style="background: var(--ai-gradient); border-radius: 50px;" id="btn-smart-book" onclick="getCompleteAIBooking()">
                        <i class="bi bi-stars"></i> Find & Book My Perfect Appointment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Appointment Options Modal -->
    <div class="modal fade" id="appointmentOptionsModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content border-0 shadow">
                <div class="modal-header ai-modal-header text-white">
                    <h5 class="modal-title"><i class="bi bi-calendar-check"></i> Choose Your Preferred Appointment</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div id="ai-recommendation-summary" class="alert alert-info mb-4"></div>
                    <h6 class="mb-3"><i class="bi bi-clock-history"></i> Available Appointment Options:</h6>
                    <div id="appointment-options-list" class="row g-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alternative Time Slots Modal -->
    <div class="modal fade" id="alternativeTimeSlotsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill"></i> Insufficient Time Available</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div id="alternative-slots-message" class="mb-3"></div>
                    <div id="alternative-slots-list"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <script>
        // AI features now use secure backend API
        // No API keys exposed to the client

        const aiModal = new bootstrap.Modal(document.getElementById('aiModal'));
        function openAIModal() { aiModal.show(); }

        // Store AI recommendation globally
        let aiRecommendation = null;

        async function analyzeSymptoms() {
            const input = document.getElementById('ai-symptom-input').value;
            const duration = document.getElementById('ai-duration-input').value;

            if(!input) {
                alert('Please describe your symptoms');
                return;
            }

            const btn = document.getElementById('btn-analyze');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Analyzing...';
            btn.disabled = true;

            try {
                // Call backend API (secure)
                const response = await fetch('/api/public/ai/analyze-symptoms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json'
                        },
                    body: JSON.stringify({ symptoms: input, duration: duration })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'AI service unavailable');
                }

                const data = await response.json();
                aiRecommendation = data; // Store the recommendation

                // Show result
                document.getElementById('ai-result').classList.remove('d-none');
                document.getElementById('ai-result').innerHTML = `
                    <strong><i class="bi bi-check-circle-fill text-success"></i> AI Recommendation</strong><br>
                    <strong>Zone:</strong> ${data.category}<br>
                    <strong>Treatment:</strong> ${data.recommendedDuration} minutes<br>
                    <small class="text-muted">${data.reason}</small><br>
                    <small class="text-muted">${data.durationReason || ''}</small>
                `;

                setTimeout(() => {
                    aiModal.hide();
                    autoSelectZoneAndPackage(data);
                }, 2500);
            } catch(error) {
                console.error('AI analysis error:', error);
                alert(error.message || "AI could not analyze. Please select manually.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function autoSelectZoneAndPackage(aiData) {
            console.log('autoSelectZoneAndPackage called with:', aiData);
            console.log('Current availableConsecutiveMinutes:', availableConsecutiveMinutes);
            console.log('Selected time slot:', selectedTimeSlot);

            let zoneName = "";
            // Mapping AI categories to zone data attributes
            const cat = aiData.category;
            if(cat.includes("neck") || cat.includes("Neck")) zoneName = "neck";
            else if(cat.includes("shoulder") || cat.includes("Shoulder")) zoneName = "shoulder";
            else if(cat.includes("back") || cat.includes("Back")) zoneName = "back";
            else if(cat.includes("knee") || cat.includes("Knee")) zoneName = "knee";
            else if(cat.includes("hip") || cat.includes("Hip")) zoneName = "hip";
            else if(cat.includes("ankle") || cat.includes("Ankle") || cat.includes("foot") || cat.includes("Foot")) zoneName = "ankle";
            else if(cat.includes("elbow") || cat.includes("Elbow")) zoneName = "elbow";
            else zoneName = "other";

            if(zoneName) {
                // Find the card by data-zone attribute
                const card = document.querySelector(`.pain-zone-card[data-zone="${zoneName}"]`);
                if(card) {
                    // Call the actual selectPainZone function from public-booking.js
                    selectPainZone(card);

                    // Add AI recommended glow effect
                    document.querySelectorAll('.pain-zone-card').forEach(c => c.classList.remove('ai-recommended'));
                    card.classList.add('ai-recommended');

                    // Check if user has selected a time slot
                    if (!selectedTimeSlot) {
                        showAlert(`AI recommends ${aiData.recommendedDuration}-minute ${zoneName} treatment. Please select a date and time first.`, 'info');
                        return;
                    }

                    // Wait for packages to actually load in the DOM
                    let attempts = 0;
                    const maxAttempts = 30; // 3 seconds max
                    const waitForPackages = setInterval(() => {
                        attempts++;
                        // Check for ALL packages including disabled ones
                        const allPackageCards = document.querySelectorAll('.package-card');
                        console.log(`Attempt ${attempts}: Found ${allPackageCards.length} package cards (including disabled)`);

                        // We expect 4 packages (30, 60, 90, 120 mins) or at least 3
                        if (allPackageCards.length >= 3) {
                            clearInterval(waitForPackages);
                            console.log('‚úì Packages loaded! Proceeding with auto-selection');

                            autoSelectPackageByDuration(aiData.recommendedDuration);

                            const packagesContainer = document.getElementById('packages-container');
                            if(packagesContainer && packagesContainer.style.display !== 'none') {
                                packagesContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }
                        } else if (attempts >= maxAttempts) {
                            clearInterval(waitForPackages);
                            console.error('‚ö† Timeout waiting for packages to load');
                            // If still no packages after timeout, try anyway
                            autoSelectPackageByDuration(aiData.recommendedDuration);
                        }
                    }, 100); // Check every 100ms
                }
            }
        }

        function autoSelectPackageByDuration(recommendedMinutes) {
            console.log('autoSelectPackageByDuration called for', recommendedMinutes, 'minutes');
            console.log('availableConsecutiveMinutes:', availableConsecutiveMinutes);

            // Find ALL package cards including disabled ones
            const allPackageCards = document.querySelectorAll('.package-card');
            const availablePackageCards = document.querySelectorAll('.package-card:not(.package-disabled)');
            console.log('Found', allPackageCards.length, 'total package cards');
            console.log('Found', availablePackageCards.length, 'available package cards');

            // Try to find a package that matches the recommended duration in ALL packages
            let bestMatch = null;
            let isDisabled = false;
            for(const card of allPackageCards) {
                try {
                    const pkg = JSON.parse(card.dataset.package);
                    console.log('Checking package:', pkg.name, pkg.durationMinutes, 'minutes', card.classList.contains('package-disabled') ? '(DISABLED)' : '(available)');
                    if(pkg.durationMinutes === recommendedMinutes) {
                        bestMatch = card;
                        isDisabled = card.classList.contains('package-disabled');
                        console.log('Found matching package:', pkg.name, isDisabled ? '(DISABLED - insufficient time)' : '(AVAILABLE)');
                        break;
                    }
                } catch(e) {
                    console.error('Error parsing package data:', e);
                    continue;
                }
            }

            // If exact match found, check if it's available or disabled
            if(bestMatch) {
                const pkg = JSON.parse(bestMatch.dataset.package);
                console.log('Best match:', pkg.name, 'Duration:', pkg.durationMinutes, 'Available time:', availableConsecutiveMinutes, 'Disabled?', isDisabled);

                if(isDisabled || pkg.durationMinutes > availableConsecutiveMinutes) {
                    // Package is disabled or not enough consecutive time - find alternative slots
                    console.log('‚ùå NOT enough time! Need', pkg.durationMinutes, 'minutes but only have', availableConsecutiveMinutes, 'minutes');
                    console.log('üîç Calling findAlternativeTimeSlots...');
                    findAlternativeTimeSlots(recommendedMinutes);
                } else {
                    // Enough time available, select the package
                    console.log('‚úì Enough time available, selecting package');
                    selectPackage(bestMatch);
                    bestMatch.classList.add('ai-recommended');

                    // Show success message
                    showAlert(`AI recommended ${pkg.durationMinutes}-minute treatment based on your symptoms`, 'info');

                    // Automatically proceed to patient info step
                    setTimeout(() => {
                        console.log('‚úì Proceeding to patient information...');
                        goToStep(3);
                    }, 1500);
                }
            } else {
                console.log('‚ùå No matching package found for', recommendedMinutes, 'minutes');
                // Even if no matching package, still try to find alternative slots
                console.log('üîç Searching for alternative time slots anyway...');
                findAlternativeTimeSlots(recommendedMinutes);
            }
        }

        // Find alternative time slots with enough consecutive time
        async function findAlternativeTimeSlots(requiredMinutes) {
            const alternativeModal = new bootstrap.Modal(document.getElementById('alternativeTimeSlotsModal'));
            const messageDiv = document.getElementById('alternative-slots-message');
            const listDiv = document.getElementById('alternative-slots-list');

            // Show loading
            messageDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Your symptoms require ${requiredMinutes}-minute treatment</strong><br>
                    Only ${availableConsecutiveMinutes} minutes available at the selected time slot.<br>
                    <small>Searching for alternative time slots...</small>
                </div>
            `;
            listDiv.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
            alternativeModal.show();

            try {
                const alternatives = [];
                const today = moment().format('YYYY-MM-DD');
                const currentSelectedDate = selectedDate;
                const currentSelectedTime = selectedTimeSlot ? selectedTimeSlot.start_time : null;

                console.log('Searching for', requiredMinutes, 'minute slots');
                console.log('Current date:', currentSelectedDate, 'Current time:', currentSelectedTime);

                // Search for slots starting from same day, then next 6 days
                for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
                    const searchDate = moment(currentSelectedDate).add(dayOffset, 'days').format('YYYY-MM-DD');

                    // Skip past dates
                    if (moment(searchDate).isBefore(today, 'day')) continue;

                    console.log('Searching date:', searchDate);

                    // Fetch time slots for this date
                    const response = await fetch(`/api/public/time-slots?clinic_id=${CLINIC_ID}&date=${searchDate}`);
                    if (!response.ok) continue;

                    const slots = await response.json();

                    // Find slots with enough consecutive time
                    for (let i = 0; i < slots.length; i++) {
                        if (!slots[i].available) continue;

                        // Skip the currently selected time slot
                        if (dayOffset === 0 && currentSelectedTime && slots[i].start_time === currentSelectedTime) {
                            continue;
                        }

                        // Calculate consecutive available minutes from this slot
                        let consecutiveMinutes = 0;
                        for (let j = i; j < slots.length && slots[j].available; j++) {
                            consecutiveMinutes += 30;
                        }

                        if (consecutiveMinutes >= requiredMinutes) {
                            const isToday = searchDate === currentSelectedDate;
                            const isBefore = isToday && currentSelectedTime && slots[i].start_time < currentSelectedTime;

                            alternatives.push({
                                date: searchDate,
                                time: slots[i].start_time,
                                consecutiveMinutes: consecutiveMinutes,
                                isToday: isToday,
                                isBefore: isBefore,
                                priority: isToday ? (isBefore ? 1 : 2) : 3 // Earlier slots on same day get priority
                            });

                            console.log('Found alternative:', searchDate, slots[i].start_time, consecutiveMinutes, 'mins');
                        }
                    }

                    // Stop if we found enough alternatives
                    if (alternatives.length >= 10) break;
                }

                // Sort alternatives by priority (same day earlier times first, then same day later times, then next days)
                alternatives.sort((a, b) => {
                    if (a.priority !== b.priority) return a.priority - b.priority;
                    if (a.date !== b.date) return a.date.localeCompare(b.date);
                    return a.time.localeCompare(b.time);
                });

                // Take top 5
                const topAlternatives = alternatives.slice(0, 5);

                console.log('Total alternatives found:', alternatives.length);
                console.log('Showing top', topAlternatives.length);

                // Display results
                if (topAlternatives.length === 0) {
                    listDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-calendar-x"></i>
                            <strong>No available time slots found</strong><br>
                            No ${requiredMinutes}-minute slots available in the next 7 days.<br>
                            <small>Please try selecting a shorter treatment duration or contact us directly.</small>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <strong>Your symptoms require ${requiredMinutes}-minute treatment</strong><br>
                            Only ${availableConsecutiveMinutes} minutes available at the selected time slot.<br>
                            <small>Here are alternative time slots with ${requiredMinutes}+ minutes available:</small>
                        </div>
                    `;

                    listDiv.innerHTML = topAlternatives.map(alt => `
                        <div class="card mb-2 border-primary" style="cursor: pointer;" onclick="selectAlternativeSlot('${alt.date}', '${alt.time}')">
                            <div class="card-body py-3">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <i class="bi bi-calendar-check-fill text-primary" style="font-size: 2rem;"></i>
                                    </div>
                                    <div class="col">
                                        <h6 class="mb-1">
                                            ${alt.isToday ? '<span class="badge bg-success">Same Day</span>' : ''}
                                            ${alt.isBefore ? '<span class="badge bg-info">Earlier Time</span>' : ''}
                                            ${moment(alt.date).format('dddd, MMMM D, YYYY')}
                                        </h6>
                                        <p class="mb-0">
                                            <i class="bi bi-clock"></i> ${alt.time}
                                            <span class="badge bg-primary">${alt.consecutiveMinutes} minutes available</span>
                                        </p>
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-primary btn-sm">
                                            <i class="bi bi-check-circle"></i> Select This Time
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error finding alternative slots:', error);
                listDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-circle"></i>
                        Error searching for alternative time slots. Please try again.
                    </div>
                `;
            }
        }

        // Select an alternative time slot
        function selectAlternativeSlot(date, time) {
            console.log('selectAlternativeSlot called:', date, time);

            // Close the modal
            const alternativeModal = bootstrap.Modal.getInstance(document.getElementById('alternativeTimeSlotsModal'));
            if (alternativeModal) {
                alternativeModal.hide();
            }

            // Update the flatpickr calendar to show the new date FIRST
            const fpInstance = document.querySelector('#date-picker')._flatpickr;
            if (fpInstance) {
                console.log('Updating calendar to:', date);
                // This will trigger the onChange event which calls loadTimeSlots
                fpInstance.setDate(date, true); // true = trigger onChange
            } else {
                // Fallback if flatpickr not found
                selectedDate = date;
                loadTimeSlots();
            }

            // Wait for time slots to load, then select the specific one
            setTimeout(() => {
                const timeSlotElements = document.querySelectorAll('.time-slot');
                console.log('Found', timeSlotElements.length, 'time slots, looking for', time);

                let found = false;
                timeSlotElements.forEach(slotEl => {
                    try {
                        const slotData = JSON.parse(slotEl.dataset.slot);
                        if (slotData.start_time === time && slotData.available) {
                            console.log('Found matching time slot, clicking it');
                            slotEl.click();
                            found = true;

                            // Scroll to time slots after selection
                            setTimeout(() => {
                                const container = document.getElementById('time-slots-container');
                                if (container) {
                                    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                }

                                // Show success message
                                showAlert(`‚úì Selected ${moment(date).format('MMM D, YYYY')} at ${time}`, 'success');

                                // Since AI already recommended a pain zone and duration,
                                // re-render packages and auto-select the recommended package
                                if (aiRecommendation && aiRecommendation.recommendedDuration) {
                                    console.log('üîÑ Re-rendering packages with updated availability after alternative slot selection...');

                                    setTimeout(() => {
                                        goToStep(2); // Go to package selection step

                                        // Re-render packages by re-selecting the currently selected pain zone
                                        // This updates package availability based on new availableConsecutiveMinutes
                                        const selectedZoneCard = document.querySelector('.pain-zone-card.selected');
                                        if (selectedZoneCard) {
                                            console.log('üîÑ Re-rendering packages for selected zone with new time availability');
                                            selectPainZone(selectedZoneCard); // Re-render packages with updated availability
                                        }

                                        // Wait for packages to re-render
                                        setTimeout(() => {
                                            console.log('‚úì Packages re-rendered! Auto-selecting AI-recommended package...');
                                            autoSelectPackageByDuration(aiRecommendation.recommendedDuration);
                                        }, 500);
                                    }, 500);
                                } else {
                                    // No AI recommendation, just go to step 2
                                    setTimeout(() => {
                                        goToStep(2);
                                    }, 1000);
                                }
                            }, 300);
                        }
                    } catch (e) {
                        console.error('Error parsing slot data:', e);
                    }
                });

                if (!found) {
                    console.error('Could not find time slot:', time);
                    showAlert('Error selecting time slot. Please try manually.', 'warning');
                }
            }, 1000); // Wait 1 second for slots to load
        }

        // Smart Booking Modal
        let smartBookingModal;
        function openSmartBookingModal() {
            if (!smartBookingModal) {
                smartBookingModal = new bootstrap.Modal(document.getElementById('smartBookingModal'));
            }
            smartBookingModal.show();
        }

        async function getCompleteAIBooking() {
            const btn = document.getElementById('btn-smart-book');
            const symptoms = document.getElementById('smart-symptom-input').value.trim();
            const duration = document.getElementById('smart-duration-input').value;
            const datePreference = document.getElementById('smart-date-preference-input').value.trim();
            const resultDiv = document.getElementById('smart-booking-result');

            // Validation
            if (!symptoms) {
                showAlert('Please describe your symptoms!', 'warning');
                return;
            }

            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>AI is analyzing and booking...';
            btn.disabled = true;
            resultDiv.classList.add('d-none');

            try {
                console.log('ü§ñ Starting complete AI booking...');

                // Step 1: Fetch available dates with time slot details (next 30 days)
                const today = moment();
                const endDate = moment().add(30, 'days');
                const availableDates = [];

                for (let date = moment(today); date.isSameOrBefore(endDate, 'day'); date.add(1, 'day')) {
                    const dateStr = date.format('YYYY-MM-DD');
                    const response = await fetch(`/api/public/time-slots?clinic_id=${CLINIC_ID}&date=${dateStr}`);
                    const slots = await response.json();

                    // Find slots with consecutive time availability
                    const slotsWithConsecutiveTime = [];
                    for (let i = 0; i < slots.length; i++) {
                        if (!slots[i].available) continue;

                        let consecutiveMinutes = 0;
                        for (let j = i; j < slots.length && slots[j].available; j++) {
                            consecutiveMinutes += 30;
                        }

                        if (consecutiveMinutes >= 30) {
                            slotsWithConsecutiveTime.push({
                                time: slots[i].start_time,
                                consecutiveMinutes: consecutiveMinutes
                            });
                        }
                    }

                    if (slotsWithConsecutiveTime.length > 0) {
                        availableDates.push({
                            date: dateStr,
                            dayName: date.format('dddd'),
                            slots: slotsWithConsecutiveTime
                        });
                    }
                }

                console.log('üìÖ Available dates with slots:', availableDates);

                // Step 2: Call comprehensive AI endpoint
                const response = await fetch('/api/public/ai/complete-booking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json'
                        },
                    body: JSON.stringify({
                        symptoms: symptoms,
                        duration: duration,
                        datePreference: datePreference || 'as soon as possible',
                        availableDates: availableDates
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'AI service unavailable');
                }

                const data = await response.json();
                console.log('üéØ AI complete recommendation:', data);

                // Store AI recommendation globally
                aiRecommendation = {
                    category: data.painZone,
                    recommendedDuration: data.treatmentDuration,
                    reason: data.symptomReason,
                    explanation: data.explanation,
                    allOptions: data.allOptions
                };

                // Show result with analysis
                resultDiv.classList.remove('d-none');
                resultDiv.innerHTML = `
                    <div class="text-success mb-2">
                        <i class="bi bi-check-circle-fill"></i> <strong>AI Analysis Complete!</strong>
                    </div>
                    <div class="small">
                        <strong>üìç Pain Zone:</strong> ${data.painZone}<br>
                        <strong>‚è±Ô∏è Recommended Treatment:</strong> ${data.treatmentDuration} minutes<br>
                        <small class="text-muted">${data.symptomReason}</small>
                    </div>
                `;

                // Hide smart booking modal and show options selection modal
                setTimeout(() => {
                    smartBookingModal.hide();
                    showAppointmentOptions(data);
                }, 2000);

            } catch(error) {
                console.error('Complete AI booking error:', error);
                showAlert(error.message || "AI could not complete booking. Please try manually.", 'warning');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Show appointment options for user to select
        let appointmentOptionsModal;
        function showAppointmentOptions(data) {
            if (!appointmentOptionsModal) {
                appointmentOptionsModal = new bootstrap.Modal(document.getElementById('appointmentOptionsModal'));
            }

            // Show summary
            document.getElementById('ai-recommendation-summary').innerHTML = `
                <strong><i class="bi bi-lightbulb-fill"></i> AI Recommendation:</strong><br>
                <strong>Pain Zone:</strong> ${data.painZone} |
                <strong>Treatment Duration:</strong> ${data.treatmentDuration} minutes<br>
                <small>${data.explanation}</small>
            `;

            // Helper function to calculate end time
            function calculateEndTime(startTime, durationMinutes) {
                const [hours, minutes, seconds] = startTime.split(':').map(Number);
                const totalMinutes = hours * 60 + minutes + durationMinutes;
                const endHours = Math.floor(totalMinutes / 60);
                const endMinutes = totalMinutes % 60;
                return `${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}:00`;
            }

            // Helper function to format time in 12-hour format
            function formatTime12Hour(time24) {
                const [hours, minutes] = time24.split(':').map(Number);
                const period = hours >= 12 ? 'PM' : 'AM';
                const hours12 = hours % 12 || 12;
                return `${hours12}:${String(minutes).padStart(2, '0')} ${period}`;
            }

            // Show all options as selectable cards
            const optionsList = document.getElementById('appointment-options-list');
            optionsList.innerHTML = '';

            data.allOptions.forEach((option, index) => {
                const isPrimary = index === 0;
                const endTime = calculateEndTime(option.time, data.treatmentDuration);
                const startTime12 = formatTime12Hour(option.time);
                const endTime12 = formatTime12Hour(endTime);

                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4';
                card.innerHTML = `
                    <div class="card h-100 option-card ${isPrimary ? 'border-success border-2' : ''}" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
                        <div class="card-body">
                            ${isPrimary ? '<div class="badge bg-success mb-2"><i class="bi bi-star-fill"></i> Top Pick</div>' : ''}
                            <h6 class="card-title">
                                <i class="bi bi-calendar-event"></i> ${moment(option.date).format('ddd, MMM D, YYYY')}
                            </h6>
                            <p class="card-text mb-2">
                                <i class="bi bi-clock"></i> <strong>${startTime12} - ${endTime12}</strong><br>
                                <small class="text-muted">${option.timeOfDay} Session</small>
                            </p>
                            <button class="btn btn-primary btn-sm w-100" onclick="selectAppointmentOption('${option.date}', '${option.time}')">
                                <i class="bi bi-check-circle"></i> Select This Time
                            </button>
                        </div>
                    </div>
                `;
                optionsList.appendChild(card);
            });

            appointmentOptionsModal.show();
        }

        // Global variable to store selected appointment
        let selectedAppointmentInfo = null;

        function selectAppointmentOption(date, time) {
            console.log('‚úì User selected:', date, time);

            // Store selection
            selectedAppointmentInfo = {
                date: date,
                time: time,
                painZone: aiRecommendation.category,
                treatmentDuration: aiRecommendation.recommendedDuration
            };

            // Hide options modal
            appointmentOptionsModal.hide();

            // Show loading message
            showAlert('Booking your appointment...', 'info');

            // Auto-complete booking with selected option
            autoCompleteBooking({
                recommendedDate: date,
                recommendedTime: time
            });
        }

        async function autoCompleteBooking(selectedOption) {
            console.log('üöÄ Auto-completing booking with:', selectedOption);

            // Step 1: Select date
            const fpInstance = document.querySelector('#date-picker')._flatpickr;
            if (fpInstance) {
                fpInstance.setDate(selectedOption.recommendedDate, true); // Triggers onChange to load time slots
            }

            // Step 2: Wait for time slots to load, then select the recommended time
            setTimeout(async () => {
                const timeSlotElements = document.querySelectorAll('.time-slot');
                let foundSlot = false;

                timeSlotElements.forEach(slotEl => {
                    const slotData = JSON.parse(slotEl.dataset.slot);
                    if (slotData.start_time === selectedOption.recommendedTime && slotData.available) {
                        console.log('‚úì Clicking selected time slot:', selectedOption.recommendedTime);
                        slotEl.click();
                        foundSlot = true;
                    }
                });

                if (foundSlot) {
                    // Step 3: After time slot selected, proceed to step 2 and auto-select zone & package
                    setTimeout(() => {
                        goToStep(2);
                        showAlert(`‚úì Selected ${moment(selectedOption.recommendedDate).format('MMM D')} at ${selectedOption.recommendedTime}`, 'success');

                        // Step 4: Auto-select pain zone and package
                        setTimeout(() => {
                            autoSelectZoneAndPackage(aiRecommendation);
                        }, 500);
                    }, 1000);
                } else {
                    showAlert('Could not auto-select time slot. Please select manually.', 'warning');
                }
            }, 1500);
        }

        // Show AI booking summary on patient info page
        function showAIBookingSummary() {
            if (selectedAppointmentInfo && aiRecommendation) {
                const summaryDiv = document.getElementById('ai-booking-summary');
                const detailsDiv = document.getElementById('ai-booking-details');

                detailsDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <small><strong>‚úì AI Diagnosed:</strong> ${selectedAppointmentInfo.painZone} pain</small><br>
                            <small><strong>‚úì Treatment Plan:</strong> ${selectedAppointmentInfo.treatmentDuration} minutes</small>
                        </div>
                        <div class="col-md-6">
                            <small><strong>‚úì Your Choice:</strong> ${moment(selectedAppointmentInfo.date).format('MMM D, YYYY')}</small><br>
                            <small><strong>‚úì Time Slot:</strong> ${selectedAppointmentInfo.time}</small>
                        </div>
                    </div>
                    <small class="text-muted mt-2 d-block"><i class="bi bi-lightbulb"></i> ${aiRecommendation.explanation || 'AI optimized this appointment based on your symptoms and schedule.'}</small>
                `;

                summaryDiv.classList.remove('d-none');
            }
        }

        // Override goToStep to show AI summary when going to step 3
        const originalGoToStep = window.goToStep;
        window.goToStep = function(step) {
            originalGoToStep(step);

            // Show AI summary when reaching patient info step
            if (step === 3 && selectedAppointmentInfo) {
                setTimeout(() => {
                    showAIBookingSummary();
                }, 100);
            }
        };

        function autoSelectDate(dateStr) {
            console.log('üóìÔ∏è Auto-selecting date:', dateStr);

            // Use flatpickr to set the date
            const fpInstance = document.querySelector('#date-picker')._flatpickr;
            if (fpInstance) {
                fpInstance.setDate(dateStr, true); // true triggers onChange
                showAlert(`‚úì Selected ${moment(dateStr).format('MMMM D, YYYY')}. Please select a time slot.`, 'success');
            }
        }

        async function polishNotes() {
            const el = document.getElementById('reason');
            const status = document.getElementById('ai-polish-status');
            if(!el.value) return;

            status.innerHTML = '<span style="color:#6366f1">AI is rewriting...</span>';

            try {
                // Call backend API (secure)
                const response = await fetch('/api/public/ai/polish-notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json'
                        },
                    body: JSON.stringify({ notes: el.value })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'AI service unavailable');
                }

                const data = await response.json();

                el.value = data.polishedNotes;
                status.innerHTML = '<span class="text-success">‚ú® Done!</span>';

                // Clear status after 3 seconds
                setTimeout(() => {
                    status.innerHTML = '';
                }, 3000);
            } catch(error) {
                console.error('AI polish error:', error);
                status.innerHTML = '<span class="text-danger">‚ùå ' + error.message + '</span>';
            }
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="/public/js/public-booking.js?v=1765446492000"></script>
</body>
</html>
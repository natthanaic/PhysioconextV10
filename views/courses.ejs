<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courses - RehabPlus System</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Design System -->
    <link href="/public/css/variables.css" rel="stylesheet">
    <link href="/public/css/base.css" rel="stylesheet">
    <link href="/public/css/accessibility.css" rel="stylesheet">

    <style>
        /* --- DASHBOARD THEME VARIABLES --- */
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --surface-color: #ffffff;
            --background-color: #f3f4f6;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            
            /* Legacy overrides */
            --input-bg: #f8fafc;
        }

        body {
            background-color: #f0f2f5; /* Matches dashboard.ejs exactly */
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- MAIN LAYOUT --- */
        main {
            padding-top: 1.5rem;
            padding-bottom: 3rem;
        }

        /* --- PAGE HEADER (Dashboard Style) --- */
        .page-header {
            background: var(--surface-color);
            border-radius: var(--border-radius-md);
            padding: 0.8rem 1.2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(255,255,255,0.5);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .page-header h1 {
            font-weight: 800;
            font-size: 1.4rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0;
        }

        .page-header .subtitle {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* --- ACTION CARDS --- */
        .action-card {
            border: none;
            border-radius: var(--border-radius-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            position: relative;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.25);
        }

        .action-card-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        /* --- TABLES & CONTENT CARDS --- */
        .card {
            border: none;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .card-header {
            background-color: var(--surface-color);
            border-bottom: 1px solid #f3f4f6;
            padding: 1rem 1.25rem;
            font-weight: 700;
            color: var(--text-main);
        }
        
        .card-header.bg-primary {
            background: var(--primary-gradient) !important;
            color: white !important;
        }
        
        .card-header.bg-success {
            background: linear-gradient(135deg, #059669 0%, #34d399 100%) !important;
            color: white !important;
        }

        .table th {
            background: #f8fafc;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .table td {
            padding: 0.75rem 1rem;
            vertical-align: middle;
            font-size: 0.85rem; /* Decreased font size for table cells */
        }

        /* --- BUTTONS --- */
        .btn {
            border: none;
            font-weight: 600;
            border-radius: 6px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            color: white;
        }

        .btn-light {
            background: #fff;
            color: var(--text-main);
            border: 1px solid #e5e7eb !important;
        }

        /* --- FORM CONTROLS --- */
        .form-control, .form-select {
            background-color: var(--input-bg);
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.6rem 0.8rem;
            font-size: 0.9rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--theme-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background-color: #fff;
        }
    </style>
</head>
<body>
    <%- include('partials/header') %>

    <a href="#main-content" class="skip-link d-none">Skip to main content</a>

    <!-- Mobile navbar toggle -->
    <nav class="navbar navbar-dark bg-dark d-md-none">
        <div class="container-fluid">
            <span class="navbar-brand font-weight-bold">RehabPlus</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <%- include('partials/sidebar', { user, activePage: 'courses' }) %>

            <!-- Main content -->
            <main id="main-content" class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                
                <!-- Page Header (Dashboard Style) -->
                <div class="page-header flex-column flex-md-row">
                    <div>
                        <h1 class="h2">Course Management</h1>
                        <span class="subtitle">Manage course packages, pricing, and purchasing</span>
                    </div>
                    <div class="mt-3 mt-md-0 d-flex align-items-center text-muted small">
                        <i class="bi bi-person-circle me-2 fs-5 text-primary"></i>
                        <span><%= user.first_name %> <%= user.last_name %> <span class="badge bg-light text-secondary border ms-1"><%= user.role %></span></span>
                    </div>
                </div>

                <div id="alertsContainer"></div>

                <!-- Two Main Action Cards -->
                <div class="row mb-4">
                    <% if (user.role === 'ADMIN') { %>
                    <div class="col-md-6 mb-3">
                        <div class="card action-card text-white h-100" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) !important;" onclick="showCourseSettings()">
                            <div class="card-body text-center p-5 d-flex flex-column justify-content-center align-items-center">
                                <i class="bi bi-gear-fill action-card-icon text-white" aria-hidden="true"></i>
                                <h3 class="card-title fw-bold">Course Settings</h3>
                                <p class="card-text opacity-75">Define course packages, pricing, and sessions</p>
                                <span class="badge bg-white text-primary mt-3 shadow-sm">Admin Only</span>
                            </div>
                        </div>
                    </div>
                    <% } %>
                    <div class="col-md-<%= user.role === 'ADMIN' ? '6' : '12' %> mb-3">
                        <div class="card action-card text-white h-100" style="background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%) !important;" onclick="showPurchaseCourse()">
                            <div class="card-body text-center p-5 d-flex flex-column justify-content-center align-items-center">
                                <i class="bi bi-cart-plus-fill action-card-icon text-white" aria-hidden="true"></i>
                                <h3 class="card-title fw-bold">Purchase PN Course</h3>
                                <p class="card-text opacity-75">Buy course packages for patients</p>
                                <span class="badge bg-white text-info mt-3 shadow-sm">All Staff</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Course Templates Section (Admin Only) -->
                <% if (user.role === 'ADMIN') { %>
                <div id="courseSettingsSection" style="display:none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold text-dark"><i class="bi bi-gear me-2 text-primary"></i>Course Templates</h5>
                        <button class="btn btn-sm btn-light border shadow-sm" onclick="hideAllSections()">
                            <i class="bi bi-x-circle me-1" aria-hidden="true"></i>Close
                        </button>
                    </div>
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center border-0">
                            <span><i class="bi bi-list-ul me-2" aria-hidden="true"></i>Active Templates</span>
                            <button class="btn btn-light btn-sm shadow-sm text-primary fw-bold" onclick="showAddTemplateModal()">
                                <i class="bi bi-plus-circle me-1" aria-hidden="true"></i>Add Template
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th class="ps-4">Template Name</th>
                                            <th>Sessions</th>
                                            <th>Price</th>
                                            <th>Validity</th>
                                            <th>Status</th>
                                            <th class="text-end pe-4">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="templatesTableBody">
                                        <tr><td colspan="6" class="text-center py-5 text-muted">Loading templates...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <% } %>

                <!-- Purchase Course Section -->
                <div id="purchaseCourseSection" style="display:none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold text-dark"><i class="bi bi-cart-plus me-2 text-info"></i>Purchase Course</h5>
                        <button class="btn btn-sm btn-light border shadow-sm" onclick="hideAllSections()">
                            <i class="bi bi-x-circle me-1" aria-hidden="true"></i>Close
                        </button>
                    </div>
                    
                    <div class="row">
                        <!-- Form Column - Full Width Stacked -->
                        <div class="col-12 mb-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-success text-white border-0">
                                    <i class="bi bi-receipt me-2" aria-hidden="true"></i>Purchase Form
                                </div>
                                <div class="card-body">
                                    <form id="purchaseCourseForm">
                                        <div class="row g-3">
                                            <!-- Patient Search -->
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label text-uppercase small fw-bold text-secondary">Search Patient <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-search text-muted" aria-hidden="true"></i></span>
                                                    <input type="text" class="form-control border-start-0" id="patientSearchInput" placeholder="HN, PT number, or name">
                                                    <button type="button" class="btn btn-primary" onclick="searchPatientsForCourse()">Search</button>
                                                </div>
                                                <div id="patientSearchResultsCourse" class="list-group mt-2 shadow-sm" style="display:none; max-height:200px; overflow-y:auto; position: absolute; width: 95%; z-index: 10;"></div>
                                                <div id="selectedPatientDisplay" class="alert alert-success mt-2 d-flex align-items-center shadow-sm border-0 p-2" style="display:none;">
                                                    <i class="bi bi-check-circle-fill me-2 fs-5"></i>
                                                    <div>
                                                        <div class="small text-uppercase fw-bold opacity-75" style="font-size: 0.7rem;">Selected</div>
                                                        <div class="fw-bold small" id="selectedPatientName"></div>
                                                    </div>
                                                </div>
                                                <input type="hidden" id="selectedPatientId">
                                            </div>

                                            <!-- Clinic Selection -->
                                            <div class="col-md-3 mb-3">
                                                <label for="courseClinic" class="form-label text-uppercase small fw-bold text-secondary">Clinic <span class="text-danger">*</span></label>
                                                <select id="courseClinic" class="form-select" required>
                                                    <option value="">Select clinic</option>
                                                </select>
                                            </div>

                                            <!-- Course Template Selection -->
                                            <div class="col-md-3 mb-3">
                                                <label for="courseTemplate" class="form-label text-uppercase small fw-bold text-secondary">Package <span class="text-danger">*</span></label>
                                                <select id="courseTemplate" class="form-select" onchange="updateCourseDetails()" required>
                                                    <option value="">Select package</option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Course Details Display -->
                                        <div id="courseDetailsDisplay" class="alert alert-light border border-info border-start-4 shadow-sm" style="display:none;">
                                            <h6 class="fw-bold text-info small"><i class="bi bi-info-circle me-2"></i>Package Details</h6>
                                            <div class="row g-2 small">
                                                <div class="col-md-4 col-6">
                                                    <div class="text-muted">Sessions</div>
                                                    <div class="fw-bold text-dark" id="displaySessions">-</div>
                                                </div>
                                                <div class="col-md-4 col-6">
                                                    <div class="text-muted">Price</div>
                                                    <div class="fw-bold text-success">฿<span id="displayPrice">-</span></div>
                                                </div>
                                                <div class="col-md-4 col-6">
                                                    <div class="text-muted">Validity</div>
                                                    <div class="fw-bold text-dark"><span id="displayValidity">-</span> Days</div>
                                                </div>
                                                <div class="col-12 border-top pt-2 mt-1">
                                                    <div class="text-muted">Description</div>
                                                    <div class="fw-bold text-dark" id="displayDescription">-</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row g-3">
                                            <!-- Custom Price (Optional) -->
                                            <div class="col-md-4 mb-3">
                                                <label for="customPrice" class="form-label text-uppercase small fw-bold text-secondary">Custom Price</label>
                                                <div class="input-group">
                                                    <span class="input-group-text bg-light">฿</span>
                                                    <input type="number" class="form-control" id="customPrice" placeholder="Override">
                                                </div>
                                            </div>

                                            <!-- Purchase Date -->
                                            <div class="col-md-4 mb-3">
                                                <label for="purchaseDate" class="form-label text-uppercase small fw-bold text-secondary">Purchase Date</label>
                                                <input type="date" class="form-control" id="purchaseDate" required>
                                            </div>
                                            
                                            <!-- Buttons -->
                                            <div class="col-md-4 mb-3 d-flex align-items-end">
                                                <button type="submit" class="btn btn-success py-2 shadow-sm w-100">
                                                    <i class="bi bi-check-circle-fill me-2" aria-hidden="true"></i>Confirm Purchase
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Notes -->
                                        <div class="mb-2">
                                            <label for="courseNotes" class="form-label text-uppercase small fw-bold text-secondary">Notes</label>
                                            <textarea class="form-control" id="courseNotes" rows="1" placeholder="Optional notes..."></textarea>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- List Column (Table) - FULL WIDTH (Stacked) -->
                        <div class="col-12 mb-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 fw-bold text-secondary"><i class="bi bi-clock-history me-2"></i>Recent Purchases</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <!-- Table updated to match user request -->
                                        <table class="table table-hover align-middle mb-0" style="font-size: 0.85rem;">
                                            <thead class="bg-light">
                                                <tr>
                                                    <th class="ps-4">CODE</th>
                                                    <th>PATIENT</th>
                                                    <th>COURSE</th>
                                                    <th>PRICE</th>
                                                    <th>SESSIONS</th>
                                                    <th>STATUS</th>
                                                    <th>VALIDITY</th>
                                                    <th class="text-end pe-4">SHARE</th>
                                                </tr>
                                            </thead>
                                            <tbody id="purchasedCoursesTableBody">
                                                <tr><td colspan="8" class="text-center py-5 text-muted">Loading history...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Template Modal -->
    <div class="modal fade" id="templateModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="templateModalTitle">Add Course Template</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="templateForm">
                        <input type="hidden" id="templateId">
                        <div class="mb-3">
                            <label for="templateName" class="form-label">Template Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="templateName" required placeholder="e.g., 10 Session Package">
                        </div>
                        <div class="mb-3">
                            <label for="templateDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="templateDescription" rows="2" placeholder="Details about this package..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="templateSessions" class="form-label">Total Sessions <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="templateSessions" required min="1" value="10">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="templatePrice" class="form-label">Default Price <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light">฿</span>
                                    <input type="number" class="form-control" id="templatePrice" required min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="templateValidity" class="form-label">Validity (Days)</label>
                            <input type="number" class="form-control" id="templateValidity" placeholder="365">
                            <div class="form-text text-muted">Leave empty for no expiry</div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch p-2 bg-light rounded border">
                                <input class="form-check-input ms-0 me-2" type="checkbox" id="templateActive" checked>
                                <label class="form-check-label fw-bold" for="templateActive">Active Status</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Family Sharing Modal -->
    <div class="modal fade" id="sharingModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-gradient-info text-white" style="background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);">
                    <h5 class="modal-title">
                        <i class="bi bi-people-fill me-2"></i>
                        Family Sharing
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="sharingCourseId">

                    <!-- Course Owner Info -->
                    <div class="alert alert-light border border-info border-start-4 shadow-sm mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong class="text-info">Course: <span id="sharingCourseCode"></span></strong>
                            <span class="badge bg-info text-white" id="sharingCourseSessions"></span>
                        </div>
                        <div class="row small text-muted">
                            <div class="col-6"><strong>Owner:</strong> <span id="sharingCourseOwner" class="text-dark"></span></div>
                            <div class="col-6"><strong>Package:</strong> <span id="sharingCourseName" class="text-dark"></span></div>
                        </div>
                    </div>

                    <!-- Add Shared User Section -->
                    <div class="card mb-4 border-0 shadow-sm bg-light">
                        <div class="card-body">
                            <h6 class="fw-bold mb-3 text-primary"><i class="bi bi-person-plus-fill me-2"></i>Add Family Member</h6>
                            <div class="mb-3">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="sharedPatientSearchInput" placeholder="Search by HN, PT number, or name">
                                    <button type="button" class="btn btn-primary" onclick="searchPatientsForSharing()">Search</button>
                                </div>
                                <div id="sharedPatientSearchResults" class="list-group mt-1 shadow-sm" style="display:none; max-height:150px; overflow-y:auto; position: absolute; width: 90%; z-index: 10;"></div>
                            </div>

                            <div id="selectedSharedPatientDisplay" class="alert alert-success d-flex justify-content-between align-items-center py-2" style="display:none;">
                                <div>
                                    <i class="bi bi-check-circle me-2"></i>
                                    <strong>Selected:</strong> <span id="selectedSharedPatientName"></span>
                                    <input type="hidden" id="selectedSharedPatientId">
                                </div>
                                <button class="btn btn-sm btn-close" onclick="document.getElementById('selectedSharedPatientDisplay').style.display='none'"></button>
                            </div>

                            <div class="d-flex gap-2 align-items-end">
                                <div class="flex-grow-1">
                                    <input type="text" class="form-control" id="sharingNotes" placeholder="Relationship (e.g., Spouse, Child)">
                                </div>
                                <button type="button" class="btn btn-success" onclick="addSharedUser()">
                                    <i class="bi bi-plus-lg"></i> Add
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Current Shared Users List -->
                    <h6 class="fw-bold text-secondary mb-3 ms-1">Current Shared Members</h6>
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0">
                            <div id="sharedUsersListContainer" class="list-group list-group-flush rounded-3">
                                <div class="text-center py-4 text-muted">Loading members...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        window.userInfo = {
            role: '<%= user.role %>',
            id: <%= user.id %>,
            clinic_id: <%= user.clinic_id || 'null' %>
        };
    </script>
    <script src="/public/js/courses.js?v=1765446492000"></script>
</body>
</html>
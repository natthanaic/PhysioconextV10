<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bills Management - RehabPlus System</title>
    <link rel="icon" href="/public/images/Fav.png" type="image/x-icon">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Design System -->
    <link href="/public/css/variables.css" rel="stylesheet">
    <link href="/public/css/base.css" rel="stylesheet">
    <link href="/public/css/accessibility.css" rel="stylesheet">
    
    <style>
        /* --- DASHBOARD THEME VARIABLES --- */
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --surface-color: #ffffff;
            --background-color: #f3f4f6;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            
            /* Legacy overrides */
            --input-bg: #f8fafc;
        }

        body {
            background-color: #f0f2f5; /* Matches dashboard.ejs exactly */
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- MAIN LAYOUT --- */
        main {
            padding-top: 1.5rem;
            padding-bottom: 3rem;
        }

        /* --- PAGE HEADER (Dashboard Style) --- */
        .page-header {
            background: var(--surface-color);
            border-radius: var(--border-radius-md);
            padding: 0.8rem 1.2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(255,255,255,0.5);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .page-header h1 {
            font-weight: 800;
            font-size: 1.4rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0;
        }

        .page-header p {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0;
        }

        /* --- CARDS --- */
        .card {
            background: var(--surface-color);
            border: none;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background-color: var(--surface-color);
            border-bottom: 1px solid #f3f4f6;
            padding: 1rem 1.25rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
        }

        /* --- BUTTONS --- */
        .btn {
            border: none;
            font-weight: 600;
            border-radius: 6px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #34d399 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);
            color: white;
        }

        /* --- FORM CONTROLS --- */
        .form-control, .form-select {
            background-color: var(--input-bg);
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--theme-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background-color: #fff;
        }
        
        .form-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        /* --- TABLE --- */
        .table th {
            background: #f8fafc;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .table td {
            padding: 0.75rem 1rem;
            vertical-align: middle;
            font-size: 0.9rem;
            color: var(--text-main);
        }

        /* --- MODALS --- */
        .modal-header {
            background: var(--primary-gradient);
            color: white;
            border-bottom: none;
            padding: 1rem 1.5rem;
        }
        
        .modal-content {
            border: none;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            border-top: 1px solid #f3f4f6;
            padding: 1rem 1.5rem;
            background: #f9fafb;
        }
        
        .btn-close-white {
            filter: brightness(0) invert(1);
            opacity: 0.8;
        }

        /* --- BADGES --- */
        .badge {
            font-weight: 600;
            padding: 0.35rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
        }

        .badge-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .badge-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .badge-warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .badge-secondary { background: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }
    </style>
</head>
<body>
    <%- include('partials/header') %>

    <a href="#main-content" class="skip-link d-none">Skip to main content</a>

    <!-- Mobile navbar toggle -->
    <nav class="navbar navbar-dark bg-dark d-md-none">
        <div class="container-fluid">
            <span class="navbar-brand font-weight-bold">RehabPlus</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <%- include('partials/sidebar', { user, activePage: 'bills' }) %>

            <main id="main-content" class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                
                <!-- Page Header (Dashboard Style) -->
                <div class="page-header flex-column flex-md-row gap-3">
                    <div>
                        <h1 class="h2">Bills Management</h1>
                        <p>Manage billing and invoices for patient services.</p>
                    </div>
                    <div class="btn-group shadow-sm" role="group">
                        <button type="button" class="btn btn-primary" id="btn-create-bill">
                            <i class="bi bi-plus-lg me-2"></i>Create Bill
                        </button>
                        <button type="button" class="btn btn-light border" id="btn-export-template">
                            <i class="bi bi-download me-2 text-success"></i>Template
                        </button>
                        <button type="button" class="btn btn-light border" id="btn-import-bills">
                            <i class="bi bi-cloud-upload me-2 text-info"></i>Import
                        </button>
                    </div>
                </div>

                <div id="alerts-container"></div>

                <!-- Unpaid Summary Cards -->
                <div class="row mb-4">
                    <!-- Unpaid Bills -->
                    <div class="col-md-3">
                        <div class="card" style="border-left: 4px solid #3b82f6;">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <p class="text-muted mb-1 text-uppercase" style="font-size: 0.7rem; font-weight: 600;">Unpaid Bills</p>
                                        <h4 class="mb-0 fw-bold text-primary" id="unpaid-bills-count">0</h4>
                                    </div>
                                    <div class="bg-primary bg-opacity-10 p-3 rounded">
                                        <i class="bi bi-receipt fs-3 text-primary"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Unpaid Bills Amount -->
                    <div class="col-md-3">
                        <div class="card" style="border-left: 4px solid #06b6d4;">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <p class="text-muted mb-1 text-uppercase" style="font-size: 0.7rem; font-weight: 600;">Bills Amount</p>
                                        <h4 class="mb-0 fw-bold text-info" id="unpaid-bills-total">฿0.00</h4>
                                    </div>
                                    <div class="bg-info bg-opacity-10 p-3 rounded">
                                        <i class="bi bi-cash-coin fs-3 text-info"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Unpaid Invoices -->
                    <div class="col-md-3">
                        <div class="card" style="border-left: 4px solid #ef4444;">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <p class="text-muted mb-1 text-uppercase" style="font-size: 0.7rem; font-weight: 600;">Unpaid Invoices</p>
                                        <h4 class="mb-0 fw-bold text-danger" id="unpaid-invoice-count">0</h4>
                                    </div>
                                    <div class="bg-danger bg-opacity-10 p-3 rounded">
                                        <i class="bi bi-file-earmark-text fs-3 text-danger"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Unpaid Invoices Amount -->
                    <div class="col-md-3">
                        <div class="card" style="border-left: 4px solid #f59e0b;">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <p class="text-muted mb-1 text-uppercase" style="font-size: 0.7rem; font-weight: 600;">Invoices Amount</p>
                                        <h4 class="mb-0 fw-bold text-warning" id="unpaid-invoice-total">฿0.00</h4>
                                    </div>
                                    <div class="bg-warning bg-opacity-10 p-3 rounded">
                                        <i class="bi bi-cash-stack fs-3 text-warning"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mb-3" id="billsInvoicesTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="bills-tab" data-bs-toggle="tab" data-bs-target="#bills-pane" type="button" role="tab">
                            <i class="bi bi-receipt me-2"></i>Bills
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices-pane" type="button" role="tab">
                            <i class="bi bi-file-earmark-text me-2"></i>Invoices
                        </button>
                    </li>
                    <% if (user.role === 'ADMIN') { %>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses-pane" type="button" role="tab">
                            <i class="bi bi-wallet2 me-2"></i>Expenses
                        </button>
                    </li>
                    <% } %>
                </ul>

                <div class="tab-content" id="billsInvoicesTabContent">
                    <!-- Bills Tab -->
                    <div class="tab-pane fade show active" id="bills-pane" role="tabpanel">
                        <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-funnel-fill me-2 text-primary"></i>Filter Options
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Bill Code</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-upc-scan text-muted"></i></span>
                                    <input type="text" id="filter-bill-code" class="form-control border-start-0" placeholder="Search code...">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Clinic</label>
                                <select id="filter-clinic" class="form-select">
                                    <option value="">All Clinics</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select id="filter-status" class="form-select">
                                    <option value="">All Status</option>
                                    <option value="PAID">Paid</option>
                                    <option value="UNPAID">Unpaid</option>
                                    <option value="PARTIAL">Partial</option>
                                    <option value="CANCELLED">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">From Date</label>
                                <input type="date" id="filter-date-from" class="form-control">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">To Date</label>
                                <input type="date" id="filter-date-to" class="form-control">
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button class="btn btn-primary w-100" id="btn-search-bills" title="Search">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bills Table -->
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th class="ps-4">Bill Code</th>
                                        <th>Patient</th>
                                        <th>Clinic</th>
                                        <th>Date</th>
                                        <th class="text-end">Amount</th>
                                        <th>Status</th>
                                        <th class="text-end pe-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="bills-table-body">
                                    <tr><td colspan="7" class="text-center py-5 text-muted">Loading records...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                    </div>
                    <!-- End Bills Tab -->

                    <!-- Invoices Tab -->
                    <div class="tab-pane fade" id="invoices-pane" role="tabpanel">
                        <!-- Invoice Filters -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-funnel-fill me-2 text-primary"></i>Filter Invoices
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Customer Name</label>
                                        <input type="text" id="filter-invoice-customer" class="form-control" placeholder="Search customer...">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Status</label>
                                        <select id="filter-invoice-status" class="form-select">
                                            <option value="">All Status</option>
                                            <option value="unpaid">Unpaid</option>
                                            <option value="paid">Paid</option>
                                            <option value="partially_paid">Partially Paid</option>
                                            <option value="cancelled">Cancelled</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Year</label>
                                        <select id="filter-invoice-year" class="form-select">
                                            <option value="">All Years</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Month</label>
                                        <select id="filter-invoice-month" class="form-select">
                                            <option value="">All Months</option>
                                            <option value="1">January</option>
                                            <option value="2">February</option>
                                            <option value="3">March</option>
                                            <option value="4">April</option>
                                            <option value="5">May</option>
                                            <option value="6">June</option>
                                            <option value="7">July</option>
                                            <option value="8">August</option>
                                            <option value="9">September</option>
                                            <option value="10">October</option>
                                            <option value="11">November</option>
                                            <option value="12">December</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button class="btn btn-primary w-100" id="btn-search-invoices" title="Search">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Invoices Table -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-file-earmark-text me-2"></i>Invoice Records</span>
                                <button class="btn btn-sm btn-success" id="btn-create-invoice">
                                    <i class="bi bi-plus-circle me-1"></i>Create Invoice
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead>
                                            <tr>
                                                <th class="ps-4">Invoice #</th>
                                                <th>Customer</th>
                                                <th>Clinic</th>
                                                <th>Date</th>
                                                <th>Due Date</th>
                                                <th class="text-end">Amount</th>
                                                <th>Status</th>
                                                <th class="text-end pe-4">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="invoices-table-body">
                                            <tr><td colspan="8" class="text-center py-5 text-muted">Loading records...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Invoices Tab -->

                    <!-- Expenses Tab (Admin Only) -->
                    <% if (user.role === 'ADMIN') { %>
                    <div class="tab-pane fade" id="expenses-pane" role="tabpanel">
                        <!-- Summary Cards -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card" style="border-left: 4px solid #ef4444;">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-grow-1">
                                                <p class="text-muted mb-1 text-uppercase" style="font-size: 0.7rem; font-weight: 600;">Expenses This Month</p>
                                                <h4 class="mb-0 fw-bold text-danger" id="expensesMonth">฿0.00</h4>
                                            </div>
                                            <div class="bg-danger bg-opacity-10 p-3 rounded">
                                                <i class="bi bi-arrow-down-circle fs-3 text-danger"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card" style="border-left: 4px solid #10b981;">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-grow-1">
                                                <p class="text-muted mb-1 text-uppercase" style="font-size: 0.7rem; font-weight: 600;">Income This Month</p>
                                                <h4 class="mb-0 fw-bold text-success" id="incomeMonth">฿0.00</h4>
                                            </div>
                                            <div class="bg-success bg-opacity-10 p-3 rounded">
                                                <i class="bi bi-arrow-up-circle fs-3 text-success"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card" style="border-left: 4px solid #3b82f6;">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-grow-1">
                                                <p class="text-muted mb-1 text-uppercase" style="font-size: 0.7rem; font-weight: 600;">Profit This Month</p>
                                                <h4 class="mb-0 fw-bold text-primary" id="profitMonth">฿0.00</h4>
                                            </div>
                                            <div class="bg-primary bg-opacity-10 p-3 rounded">
                                                <i class="bi bi-graph-up-arrow fs-3 text-primary"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card" style="border-left: 4px solid #ef4444;">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-grow-1">
                                                <p class="text-muted mb-1 text-uppercase" style="font-size: 0.7rem; font-weight: 600;">Expenses This Year</p>
                                                <h4 class="mb-0 fw-bold text-danger" id="expensesYear">฿0.00</h4>
                                            </div>
                                            <div class="bg-danger bg-opacity-10 p-3 rounded">
                                                <i class="bi bi-calendar-range fs-3 text-danger"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card" style="border-left: 4px solid #10b981;">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-grow-1">
                                                <p class="text-muted mb-1 text-uppercase" style="font-size: 0.7rem; font-weight: 600;">Income This Year</p>
                                                <h4 class="mb-0 fw-bold text-success" id="incomeYear">฿0.00</h4>
                                            </div>
                                            <div class="bg-success bg-opacity-10 p-3 rounded">
                                                <i class="bi bi-cash-stack fs-3 text-success"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card" style="border-left: 4px solid #3b82f6;">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-grow-1">
                                                <p class="text-muted mb-1 text-uppercase" style="font-size: 0.7rem; font-weight: 600;">Profit This Year</p>
                                                <h4 class="mb-0 fw-bold text-primary" id="profitYear">฿0.00</h4>
                                            </div>
                                            <div class="bg-primary bg-opacity-10 p-3 rounded">
                                                <i class="bi bi-trophy fs-3 text-primary"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filters -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-funnel-fill me-2 text-primary"></i>Filter Expenses
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Category</label>
                                        <select class="form-select" id="filterCategory">
                                            <option value="">All Categories</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Year</label>
                                        <select class="form-select" id="filterYear">
                                            <option value="">All Years</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Month</label>
                                        <select class="form-select" id="filterMonth">
                                            <option value="">All Months</option>
                                            <option value="1">January</option>
                                            <option value="2">February</option>
                                            <option value="3">March</option>
                                            <option value="4">April</option>
                                            <option value="5">May</option>
                                            <option value="6">June</option>
                                            <option value="7">July</option>
                                            <option value="8">August</option>
                                            <option value="9">September</option>
                                            <option value="10">October</option>
                                            <option value="11">November</option>
                                            <option value="12">December</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 d-flex align-items-end">
                                        <button class="btn btn-primary w-100" onclick="ExpenseManager.loadExpenses()">
                                            <i class="bi bi-funnel me-2"></i>Filter
                                        </button>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button class="btn btn-secondary w-100" onclick="ExpenseManager.clearFilters()">
                                            <i class="bi bi-x-circle me-2"></i>Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Add Expense Button -->
                        <div class="d-flex justify-content-end mb-3">
                            <button class="btn btn-primary" onclick="ExpenseManager.showAddModal()">
                                <i class="bi bi-plus-circle me-2"></i>Add Expense
                            </button>
                        </div>

                        <!-- Expenses Table -->
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-receipt me-2"></i>Expense Records
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Category</th>
                                                <th>Description</th>
                                                <th>Receipt #</th>
                                                <th>Amount</th>
                                                <th>Created By</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="expensesTableBody">
                                            <tr>
                                                <td colspan="7" class="text-center py-5 text-muted">Loading...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Expenses Tab -->
                    <% } %>
                </div>
                <!-- End Tab Content -->
            </main>
        </div>
    </div>

    <!-- Create Bill Modal -->
    <div class="modal fade" id="createBillModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>Create New Bill</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Patient Selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Patient</label>
                            <input type="hidden" id="bill-patient-id">
                            <div class="input-group">
                                <input type="text" id="bill-patient-name" class="form-control bg-light" readonly placeholder="No patient selected">
                                <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('bill-patient-search').focus()">Change</button>
                            </div>
                            <input type="text" id="bill-patient-search" class="form-control mt-2" placeholder="Type name, HN or phone to search...">
                            <div id="patient-search-results" class="list-group mt-1 shadow-sm" style="position:absolute; width:95%; z-index:10; max-height:200px; overflow:auto;"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Walk-in Patient (Optional)</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="text" id="bill-walk-in-name" class="form-control" placeholder="Name">
                                </div>
                                <div class="col-6">
                                    <input type="text" id="bill-walk-in-phone" class="form-control" placeholder="Phone">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="patient-courses-info" class="mb-3"></div>

                    <!-- Clinic Selection (Required) -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Clinic <span class="text-danger">*</span></label>
                            <select id="bill-clinic" class="form-select" required>
                                <option value="">Select Clinic</option>
                            </select>
                        </div>
                    </div>

                    <!-- Bill Details -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Bill Date</label>
                            <input type="date" id="bill-date" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Payment Method</label>
                            <select id="bill-payment-method" class="form-select">
                                <option value="">Select method</option>
                                <option value="CASH">Cash</option>
                                <option value="CREDIT_CARD">Credit Card</option>
                                <option value="TRANSFER">Bank Transfer</option>
                            </select>
                        </div>
                    </div>

                    <!-- Add Items -->
                    <div class="card bg-light border-0 mb-4">
                        <div class="card-body">
                            <h6 class="card-title fw-bold mb-3">Add Items</h6>
                            <div class="row g-2">
                                <div class="col-md-5">
                                    <select id="bill-item-service" class="form-select">
                                        <option value="">Select Service / Product</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" id="bill-item-quantity" class="form-control" value="1" min="1" placeholder="Qty">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" id="bill-item-discount" class="form-control" value="0" min="0" placeholder="Disc.">
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-success w-100" id="btn-add-bill-item">
                                        <i class="bi bi-plus-circle me-1"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="bill-items-container" class="mb-3 table-responsive">
                        <table class="table table-bordered bg-white">
                            <thead class="bg-light">
                                <tr>
                                    <th>Item</th>
                                    <th style="width: 100px;">Price</th>
                                    <th style="width: 80px;">Qty</th>
                                    <th style="width: 100px;">Discount</th>
                                    <th style="width: 100px;">Total</th>
                                    <th style="width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="text-center text-muted py-3">No items added</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Totals -->
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Notes</label>
                            <textarea id="bill-notes" class="form-control" rows="3" placeholder="Additional notes..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light border-0">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <span class="fw-bold" id="bill-subtotal">฿0.00</span>
                                    </div>
                                    <div class="row mb-2 align-items-center">
                                        <div class="col-6">Discount:</div>
                                        <div class="col-6">
                                            <input type="number" id="bill-discount" class="form-control form-control-sm text-end" value="0" min="0">
                                        </div>
                                    </div>
                                    <div class="row mb-3 align-items-center border-bottom pb-3">
                                        <div class="col-6">Tax:</div>
                                        <div class="col-6">
                                            <input type="number" id="bill-tax" class="form-control form-control-sm text-end" value="0" min="0">
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Total:</h5>
                                        <h4 class="mb-0 text-primary fw-bold" id="bill-total">฿0.00</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary px-4" id="btn-save-bill">Save Bill</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Bill Modal -->
    <div class="modal fade" id="viewBillModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-gradient-info text-white" style="background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);">
                    <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>Bill Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4" id="bill-details-content">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">Loading details...</p>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Simplified PN Bill Creation Modal -->
    <div class="modal fade" id="createPNBillModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-receipt-cutoff me-2"></i>Create Bill for PN Case</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- PN Case Information -->
                    <div class="alert alert-success bg-opacity-10 border-success mb-4">
                        <h6 class="alert-heading fw-bold mb-3"><i class="bi bi-info-circle me-2"></i>Case Information</h6>
                        <div class="row small">
                            <div class="col-md-4 mb-2"><strong>PN Code:</strong> <span id="pn-bill-pn-code">-</span></div>
                            <div class="col-md-4 mb-2"><strong>Patient:</strong> <span id="pn-bill-patient-name">-</span></div>
                            <div class="col-md-4 mb-2"><strong>HN:</strong> <span id="pn-bill-patient-hn">-</span></div>
                            <div class="col-md-4 mb-2"><strong>Diagnosis:</strong> <span id="pn-bill-diagnosis">-</span></div>
                            <div class="col-md-4 mb-2"><strong>Purpose:</strong> <span id="pn-bill-purpose">-</span></div>
                            <div class="col-md-4 mb-2"><strong>Clinic:</strong> <span id="pn-bill-clinic-name">-</span></div>
                        </div>
                    </div>

                    <input type="hidden" id="pn-bill-pn-id">
                    <input type="hidden" id="pn-bill-patient-id">
                    <input type="hidden" id="pn-bill-clinic-id">

                    <!-- Service Selection -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <h6 class="card-title fw-bold mb-3 text-secondary">Add Services</h6>
                            <div class="row g-2 align-items-end">
                                <div class="col-md-5">
                                    <label class="form-label">Service</label>
                                    <select id="pn-bill-service" class="form-select">
                                        <option value="">Select Service</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Quantity</label>
                                    <input type="number" id="pn-bill-quantity" class="form-control" value="1" min="1">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Discount (฿)</label>
                                    <input type="number" id="pn-bill-item-discount" class="form-control" value="0" min="0">
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-success w-100" id="btn-add-pn-bill-item">
                                        <i class="bi bi-plus-lg me-1"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <div id="pn-bill-items-container" class="table-responsive mb-4">
                        <table class="table table-bordered align-middle">
                            <thead class="bg-light">
                                <tr>
                                    <th>Item</th>
                                    <th>Price</th>
                                    <th>Qty</th>
                                    <th>Discount</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="text-center text-muted py-3">No services added yet</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Totals & Payment -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Payment Method</label>
                                <select id="pn-bill-payment-method" class="form-select">
                                    <option value="">Select method</option>
                                    <option value="CASH">Cash</option>
                                    <option value="CREDIT_CARD">Credit Card</option>
                                    <option value="TRANSFER">Bank Transfer</option>
                                    <option value="QR_CODE">QR Code</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <input type="text" id="pn-bill-notes" class="form-control" placeholder="Optional notes...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light border-0 h-100">
                                <div class="card-body d-flex flex-column justify-content-center">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <span class="fw-bold" id="pn-bill-subtotal">฿0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between border-top pt-2 mt-2">
                                        <h5 class="mb-0">Total:</h5>
                                        <h4 class="mb-0 text-success fw-bold" id="pn-bill-total">฿0.00</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success px-4" id="btn-save-pn-bill">
                        <i class="bi bi-check2-circle me-2"></i>Create Bill
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Bills Modal -->
    <div class="modal fade" id="importBillsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-upload me-2"></i>Import Bills</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info border-0 shadow-sm mb-4">
                        <div class="d-flex">
                            <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                            <div>
                                <strong>How to Import:</strong>
                                <ol class="mb-0 ps-3 small mt-1">
                                    <li>Download the template.</li>
                                    <li>Fill in bill data.</li>
                                    <li>Upload the CSV file.</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="import-file" class="form-label fw-bold small text-uppercase text-secondary">Select CSV File</label>
                        <input class="form-control" type="file" id="import-file" accept=".csv">
                    </div>

                    <div id="import-preview" class="mt-3" style="display: none;">
                        <h6 class="fw-bold small text-uppercase text-secondary mb-2">Preview</h6>
                        <div id="import-preview-content" class="border rounded p-2 bg-light small" style="max-height: 150px; overflow: auto;"></div>
                    </div>

                    <div id="import-results" class="mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary px-4" id="btn-upload-csv" disabled>
                        <i class="bi bi-cloud-upload me-2"></i>Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Invoice Modal -->
    <div class="modal fade" id="createInvoiceModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="invoiceModalTitle"><i class="bi bi-file-earmark-text me-2"></i>Create Invoice</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="invoice-id">

                    <!-- Customer Information -->
                    <div class="card bg-light border-0 mb-4">
                        <div class="card-body">
                            <h6 class="card-title fw-bold mb-3">Customer Information</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Customer Name *</label>
                                    <input type="text" id="invoice-customer-name" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <input type="email" id="invoice-customer-email" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Phone</label>
                                    <input type="text" id="invoice-customer-phone" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Clinic *</label>
                                    <select id="invoice-clinic" class="form-select" required>
                                        <option value="">Select Clinic</option>
                                    </select>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Address</label>
                                    <textarea id="invoice-customer-address" class="form-control" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Details -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label class="form-label">Invoice Date *</label>
                            <input type="date" id="invoice-date" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Due Date</label>
                            <input type="date" id="invoice-due-date" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Payment Method</label>
                            <select id="invoice-payment-method" class="form-select">
                                <option value="">Select method</option>
                                <option value="CASH">Cash</option>
                                <option value="CREDIT_CARD">Credit Card</option>
                                <option value="TRANSFER">Bank Transfer</option>
                                <option value="QR_CODE">QR Code</option>
                            </select>
                        </div>
                    </div>

                    <!-- Add Items -->
                    <div class="card bg-light border-0 mb-4">
                        <div class="card-body">
                            <h6 class="card-title fw-bold mb-3">Add Items/Services</h6>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <select id="invoice-item-service" class="form-select">
                                        <option value="">Select Service (optional)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="text" id="invoice-item-name" class="form-control" placeholder="Item Name *">
                                </div>
                                <div class="col-md-1">
                                    <input type="number" id="invoice-item-quantity" class="form-control" value="1" min="1" placeholder="Qty">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" id="invoice-item-price" class="form-control" value="0" min="0" step="0.01" placeholder="Price">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-success w-100" id="btn-add-invoice-item">
                                        <i class="bi bi-plus-circle me-1"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <div id="invoice-items-container" class="mb-3 table-responsive">
                        <table class="table table-bordered bg-white">
                            <thead class="bg-light">
                                <tr>
                                    <th>Item</th>
                                    <th style="width: 100px;">Price</th>
                                    <th style="width: 80px;">Qty</th>
                                    <th style="width: 120px;">Total</th>
                                    <th style="width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5" class="text-center text-muted py-3">No items added</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Totals and Notes -->
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Notes</label>
                            <textarea id="invoice-notes" class="form-control" rows="3" placeholder="Additional notes..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light border-0">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <span class="fw-bold" id="invoice-subtotal">฿0.00</span>
                                    </div>
                                    <div class="row mb-2 align-items-center">
                                        <div class="col-6">Tax:</div>
                                        <div class="col-6">
                                            <input type="number" id="invoice-tax" class="form-control form-control-sm text-end" value="0" min="0" step="0.01">
                                        </div>
                                    </div>
                                    <div class="row mb-3 align-items-center border-bottom pb-3">
                                        <div class="col-6">Discount:</div>
                                        <div class="col-6">
                                            <input type="number" id="invoice-discount" class="form-control form-control-sm text-end" value="0" min="0" step="0.01">
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Total:</h5>
                                        <h4 class="mb-0 text-success fw-bold" id="invoice-total">฿0.00</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light border" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success px-4" id="btn-save-invoice">Save Invoice</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Expense Modal (Admin Only) -->
    <% if (user.role === 'ADMIN') { %>
    <div class="modal fade" id="expenseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="expenseModalTitle">Add Expense</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="expenseForm">
                        <input type="hidden" id="expenseId">
                        <div class="mb-3">
                            <label for="expenseCategory" class="form-label">Category *</label>
                            <select class="form-select" id="expenseCategory" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="expenseAmount" class="form-label">Amount (฿) *</label>
                            <input type="number" class="form-control" id="expenseAmount" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="expenseDate" class="form-label">Date *</label>
                            <input type="date" class="form-control" id="expenseDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="expenseReceipt" class="form-label">Receipt Number</label>
                            <input type="text" class="form-control" id="expenseReceipt">
                        </div>
                        <div class="mb-3">
                            <label for="expenseDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="expenseDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="ExpenseManager.saveExpense()">Save</button>
                </div>
            </div>
        </div>
    </div>
    <% } %>

    <input type="hidden" id="user-clinic-id" value="<%= user.clinic_id %>">
    <input type="hidden" id="user-role" value="<%= user.role %>">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        window.userInfo = {
            id: <%= user.id %>,
            role: <%- JSON.stringify(user.role) %>,
            email: <%- JSON.stringify(user.email || '') %>
        };
    </script>
    <script src="/public/js/bills.js?v=1765446492000<%= Date.now() %>"></script>
    <% if (user.role === 'ADMIN') { %>
    <script src="/public/js/expenses.js?v=1765446492000<%= Date.now() %>"></script>
    <script>
        // Initialize ExpenseManager when expenses tab is shown
        let expenseManagerInitialized = false;

        document.addEventListener('DOMContentLoaded', () => {
            const expensesTab = document.getElementById('expenses-tab');

            if (expensesTab) {
                expensesTab.addEventListener('shown.bs.tab', async () => {
                    if (!expenseManagerInitialized && typeof ExpenseManager !== 'undefined') {
                        console.log('Initializing ExpenseManager...');
                        await ExpenseManager.init();
                        expenseManagerInitialized = true;
                    }
                });
            }
        });
    </script>
    <% } %>
</body>
</html>